<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chief of Staff</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' http://127.0.0.1:8787 ws://127.0.0.1:8787;">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Load design system -->
  <link rel="stylesheet" href="design/modern-tokens.css?v=8">
  
  <!-- Load fonts from Google -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Load React for development -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <style>
    /* Base reset and app styles */
    * { box-sizing: border-box; }
    
    html, body, #root {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: var(--font-family);
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
    }

    /* App layout */
    .app-layout {
      display: grid;
      grid-template-columns: 80px minmax(300px, 400px) 1fr;
      grid-template-rows: 1px 1fr auto 1px;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: var(--bg-primary);
      position: fixed;
      top: 0;
      left: 0;
    }

    /* Top and bottom borders spanning all columns */
    .app-layout::before,
    .app-layout::after {
      content: '';
      grid-column: 1 / -1;
      background: var(--border);
      height: 1px;
    }

    .app-layout::before {
      grid-row: 1;
    }

    .app-layout::after {
      grid-row: 4;
    }

    @media (max-width: 1024px) {
      .app-layout {
        grid-template-columns: 80px minmax(280px, 350px) 1fr;
      }
    }

    @media (max-width: 768px) {
      .app-layout {
        grid-template-columns: 60px minmax(250px, 300px) 1fr;
      }
      
      .icon-sidebar {
        padding: 16px 8px;
      }
      
      .icon-btn {
        width: 40px;
        height: 40px;
      }
    }

    /* Status bar */
    .status-bar {
      grid-column: 1 / -1;
      grid-row: 3;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border);
      padding: 8px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
      min-height: 32px;
      z-index: 10;
      position: sticky;
      bottom: 0;
      font-family: var(--font-mono);
    }

    @media (max-width: 768px) {
      .status-bar {
        padding: 8px 16px;
        font-size: 11px;
      }
      
      .status-indicators {
        gap: 16px;
      }
      
      .status-indicator span {
        display: none;
      }
      
      .status-indicator::after {
        content: attr(data-label);
        font-size: 10px;
        margin-left: 4px;
      }
    }

    .status-indicators {
      display: flex;
      gap: 24px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator .status-dot {
      width: 6px;
      height: 6px;
    }
    
    .status-indicator {
      font-size: 11px;
    }
    
    .status-indicator.connected {
      color: var(--success);
    }
    
    .status-indicator.connecting {
      color: var(--warning);
    }
    
    .status-indicator.disconnected {
      color: var(--error);
    }
    
    .status-indicator.ai {
      color: var(--info);
    }

    /* Icon sidebar */
    .icon-sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .icon-nav {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .icon-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 12px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icon-btn:hover {
      background: var(--surface-hover);
      color: var(--text-primary);
    }

    .icon-btn.active {
      background: var(--brand-primary);
      color: var(--bg-primary);
    }

    /* Chat sidebar */
    .chat-sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .chat-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: var(--brand-primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .chat-title h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.connected { background: var(--success); }
    .status-dot.connecting { background: var(--warning); }
    .status-dot.disconnected { background: var(--error); }

    .status-text {
      font-size: 14px;
      color: var(--text-muted);
    }

    .chat-messages {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .chat-input-area {
      padding: 24px;
      border-top: 1px solid var(--border, #334155);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
    }

    .chat-input-field {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .chat-input-field:focus {
      outline: none;
      border-color: var(--brand-primary);
    }

    .chat-send-btn {
      padding: 12px 16px;
      background: var(--brand-primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
    }

    .chat-send-btn:hover:not(:disabled) {
      background: var(--brand-hover);
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Main content */
    .main-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .content-area {
      flex: 1;
      padding: 48px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Ensures flex children can shrink */
    }

    /* Email Intelligence Layout - Analysis Left, List Right */
    .email-management {
      display: grid;
      grid-template-columns: 2fr 1fr;  /* Analysis panel gets more space */
      gap: 24px;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    @media (max-width: 1200px) {
      .email-management {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 300px;  /* Analysis first, then compact email list */
        gap: 16px;
      }
    }

    @media (max-width: 768px) {
      .email-management {
        gap: 12px;
      }
      
      .content-area {
        padding: 24px 16px;
      }
      
      .email-panel {
        padding: 16px;
      }
    }

    .email-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
      min-height: 0;
    }

    .panel-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0; /* Prevent header from shrinking */
      min-height: 60px; /* Fixed minimum height */
    }

    .panel-title {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .panel-subtitle {
      margin: 0;
      font-size: 14px;
      color: var(--text-muted);
    }

    .email-list {
      flex: 1 1 0;
      overflow-y: auto;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
      height: 100%;
      box-sizing: border-box;
    }

    .email-item {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-primary);
    }

    .email-item:hover {
      background: var(--surface-hover);
      border-color: var(--brand-primary);
    }

    .email-item.selected {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--brand-primary);
    }

    .email-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .email-sender {
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
    }

    .email-time {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
    }

    .email-subject {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .email-preview {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      line-height: var(--line-height-tight);
    }

    .email-priority {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      margin-top: 8px;
    }

    .priority-high {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .priority-medium {
      background: rgba(234, 179, 8, 0.2);
      color: var(--warning);
    }

    .priority-low {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    /* Email detail */
    .email-detail-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
    }

    .empty-icon {
      margin-bottom: 16px;
      color: var(--text-muted);
      opacity: 0.5;
    }

    .empty-title {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: var(--text-primary);
    }

    .empty-description {
      margin: 0;
      color: var(--text-muted);
      font-size: 16px;
      line-height: 1.5;
      max-width: 400px;
    }

    /* Chat interface */
    .chat-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 24px;
    }

    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
    }

    .welcome-icon {
      margin-bottom: 24px;
      color: var(--text-muted);
      opacity: 0.8;
    }

    .welcome-title {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .welcome-description {
      margin: 0 0 32px 0;
      color: var(--text-muted);
      font-size: 16px;
      max-width: 400px;
    }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      max-width: 300px;
    }

    .quick-action {
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--brand-primary, #3b82f6);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .quick-action:hover {
      background: var(--surface-hover, #475569);
      border-color: var(--brand-primary);
    }

    /* Processing dots animation */
    .processing-dots {
      position: absolute;
      bottom: 8px;
      right: 12px;
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 12px;
      color: var(--brand-primary);
      font-weight: 600;
    }

    .dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--brand-primary);
      animation: pulse 1.5s infinite;
    }

    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    .dot:nth-child(4) { animation-delay: 0.6s; }

    @keyframes pulse {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1.2); }
    }

    /* Email list loading states */
    .email-list-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      padding: 24px;
      text-align: center;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--brand-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .loading-subtext {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Project Management Styles */
    .project-management {
      display: grid;
      grid-template-columns: 2fr 1fr;  /* Task workspace gets more space */
      gap: 24px;
      flex: 1;
      min-height: 0;
    }

    .task-panel, .project-navigator {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .task-panel {
      padding: 24px;
    }

    .project-navigator {
      padding: 16px;
    }

    .panel-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .panel-title {
      margin: 0 0 4px 0;
      color: var(--text-primary);
      font-size: 18px;
      font-weight: 600;
    }

    .panel-subtitle {
      margin: 0;
      color: var(--text-muted);
      font-size: 14px;
    }

    .panel-actions {
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
    }

    .navigator-header {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navigator-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }

    /* Areas and Projects Tree */
    .areas-list {
      flex: 1;
      overflow-y: auto;
    }

    .area-item {
      margin-bottom: 16px;
    }

    .area-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .area-header:hover {
      background: var(--surface-hover);
      border-color: var(--brand-primary);
    }

    .area-item.selected .area-header {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--brand-primary);
    }

    .area-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .area-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Vertical Tabs for Areas */
    .area-tabs-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .area-tabs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .area-tabs-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .carousel-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .carousel-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .carousel-btn:hover:not(:disabled) {
      background: var(--surface-hover);
      border-color: var(--brand-primary);
      color: var(--brand-primary);
    }
    
    .carousel-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: var(--surface);
      border-color: var(--border);
      color: var(--text-muted);
    }
    
    .carousel-indicator {
      font-size: 12px;
      color: var(--text-muted);
      min-width: 60px;
      text-align: center;
    }

    .area-tabs-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .area-tabs-list {
      display: flex;
      flex-direction: row;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: hidden;
      overflow-y: visible;
      flex-wrap: nowrap;
      transition: transform var(--transition-normal);
    }

    .area-tab {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      white-space: nowrap;
      flex-shrink: 0;
      width: 160px; /* Fixed width to prevent different sizes */
    }

    .area-tab:hover {
      background: var(--surface-hover);
      border-color: var(--brand-primary);
    }

    .area-tab.active {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--brand-primary);
      color: var(--brand-primary);
    }

    .area-tab.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }

    .area-tab.drag-over {
      border-color: var(--brand-primary);
      background: rgba(59, 130, 246, 0.05);
    }

    .area-tab-name {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      margin-right: 8px;
    }

    .area-tab.active .area-tab-name {
      color: var(--brand-primary);
    }

    .area-tab-count {
      font-size: 11px;
      color: white;
      background: var(--brand-primary);
      padding: 3px 7px;
      border-radius: 14px;
      white-space: nowrap;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      line-height: 1;
      flex-shrink: 0;
    }

    .area-tab-drag-handle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      cursor: grab;
      opacity: 0;
      transition: opacity 0.2s ease;
      margin-left: 4px;
      flex-shrink: 0;
      font-size: 12px;
    }

    .area-tab:hover .area-tab-drag-handle {
      opacity: 1;
    }

    .area-tab-drag-handle:active {
      cursor: grabbing;
    }

    .area-overflow-menu {
      position: relative;
      flex-shrink: 0;
    }

    .area-overflow-tab {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-muted);
      font-size: 16px;
      min-width: 50px;
      height: 36px;
    }

    .area-overflow-tab:hover {
      background: var(--surface-hover);
      border-color: var(--brand-primary);
      color: var(--brand-primary);
    }

    .area-overflow-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 200px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .area-overflow-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
      border-bottom: 1px solid var(--border);
    }

    .area-overflow-item:last-child {
      border-bottom: none;
    }

    .area-overflow-item:hover {
      background: var(--surface-hover);
    }

    .area-overflow-item.active {
      background: rgba(59, 130, 246, 0.1);
      color: var(--brand-primary);
    }

    /* Projects Section Styling */
    .projects-section {
      margin-top: 20px;
    }

    .projects-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-left: 0; /* Align with area tabs */
    }

    .projects-header h4 {
      margin: 0;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }

    .projects-list {
      margin-top: 8px;
      padding-left: 0; /* Align with area tabs - no additional indent */
    }

    /* Tasks Header Styling - matches projects-header */
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .tasks-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .project-actions {
      margin-bottom: 12px;
    }

    .project-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      margin-bottom: 4px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .project-item:hover {
      background: var(--surface-hover);
    }

    .project-item.selected {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--brand-primary);
    }

    .project-name {
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      flex: 1;
      margin-right: 8px;
    }

    .project-priority {
      margin-right: 8px;
      font-size: 9px;
      width: 60px;
      flex-shrink: 0;
    }

    .project-status, .task-status {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      flex-shrink: 0;
      width: 70px;
      text-align: center;
    }
    
    .project-status {
      margin-right: 8px;
    }
    
    .task-status {
      min-width: 80px;
      text-align: center;
      align-self: center;
    }

    .status-active {
      background: rgba(34, 197, 94, 0.2);
      color: rgb(34, 197, 94);
    }

    .status-paused {
      background: rgba(251, 191, 36, 0.2);
      color: rgb(251, 191, 36);
    }

    .status-completed {
      background: rgba(59, 130, 246, 0.2);
      color: rgb(59, 130, 246);
    }

    .status-archived {
      background: rgba(107, 114, 128, 0.2);
      color: rgb(107, 114, 128);
    }

    .status-pending {
      background: rgba(156, 163, 175, 0.2);
      color: rgb(156, 163, 175);
    }

    .status-in_progress {
      background: rgba(59, 130, 246, 0.2);
      color: rgb(59, 130, 246);
    }

    .status-blocked {
      background: rgba(239, 68, 68, 0.2);
      color: rgb(239, 68, 68);
    }

    .project-task-count {
      font-size: 11px;
      color: white;
      background: var(--brand-primary);
      padding: 3px 7px;
      border-radius: 14px;
      white-space: nowrap;
      min-width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      line-height: 1;
      margin-left: 8px;
    }

    /* Task List */
    .task-list {
      flex: 1;
      overflow-y: auto;
    }

    .task-item {
      display: flex;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .task-item:hover {
      background: var(--surface-hover);
      border-color: var(--brand-primary);
    }

    .task-item.selected {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--brand-primary);
    }

    .task-item.saving {
      opacity: 0.7;
      pointer-events: none;
    }

    .task-item.saving::after {
      content: "Saving...";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: var(--text-secondary);
      background: var(--surface);
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 10;
    }

    .task-content {
      flex: 1;
    }

    .task-title {
      margin: 0 0 4px 0;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }

    .editable-field {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
    }

    .editable-field:hover {
      background-color: var(--bg-secondary);
    }

    .task-objective {
      margin: 0 0 8px 0;
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      line-height: var(--line-height-tight);
    }

    .task-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .task-sponsor, .task-owner, .task-due, .task-priority {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      padding: 2px 6px;
      background: var(--surface);
      border-radius: 4px;
      margin-top: 4px;
      margin-right: 8px;
      display: inline-block;
    }
    
    /* Priority-specific styling */
    .task-priority[data-priority="1"] {
      background: rgba(239, 68, 68, 0.1);
      color: rgb(239, 68, 68);
      font-weight: 600;
    }
    
    .task-priority[data-priority="2"] {
      background: rgba(245, 158, 11, 0.1);
      color: rgb(245, 158, 11);
      font-weight: 500;
    }
    
    .task-priority[data-priority="3"],
    .task-priority[data-priority="4"],
    .task-priority[data-priority="5"] {
      background: rgba(107, 114, 128, 0.1);
      color: rgb(107, 114, 128);
      font-weight: 400;
    }

    .status-archived {
      background: rgba(107, 114, 128, 0.2);
      color: rgb(107, 114, 128);
    }

    /* Context Menu Styles */
    .context-menu {
      position: absolute;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      padding: 4px 0;
      min-width: 160px;
      z-index: 1000;
      font-size: var(--font-size-sm);
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color var(--duration-fast) var(--ease);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      color: var(--text-primary);
    }

    .context-menu-item:hover {
      background: var(--surface-hover);
    }

    .context-menu-item.destructive {
      color: var(--error);
    }

    .context-menu-item.destructive:hover {
      background: var(--error-bg);
    }

    /* Confirmation Dialog */
    .confirmation-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .confirmation-dialog {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      min-width: 400px;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
    }

    .confirmation-dialog-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .confirmation-dialog-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
    }

    .confirmation-dialog-icon.warning {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .confirmation-dialog-icon.danger {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .confirmation-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .confirmation-dialog-message {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 24px;
    }

    .confirmation-dialog-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .confirmation-dialog-button {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }

    .confirmation-dialog-button.cancel {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .confirmation-dialog-button.cancel:hover {
      background: var(--surface-hover);
    }

    .confirmation-dialog-button.confirm {
      background: var(--brand-primary);
      color: white;
    }

    .confirmation-dialog-button.confirm:hover {
      background: var(--brand-hover);
    }

    .confirmation-dialog-button.danger {
      background: var(--error-bg);
      color: var(--error);
    }

    .confirmation-dialog-button.danger:hover {
      background: rgba(239, 68, 68, 0.8);
      color: white;
    }

    /* Archive Sections */
    .archive-section {
      margin-top: 16px;
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }

    .archive-section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }

    .archive-section-header:hover {
      background: var(--surface-hover);
      color: var(--text-secondary);
    }

    .archive-section-chevron {
      width: 16px;
      height: 16px;
      transition: transform 0.2s ease;
    }

    .archive-section-chevron.expanded {
      transform: rotate(90deg);
    }

    .archive-section-content {
      margin-top: 8px;
      overflow: hidden;
    }

    .archive-section-content.collapsed {
      display: none;
    }

    .archive-section-item {
      opacity: 0.7;
    }

    .archive-section-item:hover {
      opacity: 1;
    }

    .archive-section-count {
      background: var(--bg-secondary);
      color: var(--text-muted);
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 12px;
      min-width: 18px;
      text-align: center;
    }

    /* Inline Editing */
    .item-editing {
      background: rgba(59, 130, 246, 0.05) !important;
      border: 1px solid var(--brand-primary) !important;
      outline: none;
    }

    .editing-field {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-primary);
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
      padding: 2px 4px;
      border-radius: 4px;
      width: 100%;
      transition: all 0.2s ease;
    }

    .editing-field:focus {
      background: var(--bg-primary);
      border-color: var(--brand-primary);
      outline: none;
    }

    .editing-field.template {
      color: var(--text-muted);
      font-style: italic;
    }

    .editing-field.template:focus {
      color: var(--text-primary);
      font-style: normal;
    }

    .editing-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    .editing-actions .btn {
      padding: 4px 12px;
      font-size: 12px;
    }

    .area-tab.editing {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--brand-primary);
    }

    .area-tab .editing-field {
      background: transparent;
      border: none;
      font-size: 13px;
      font-weight: 500;
      text-align: center;
      min-width: 60px;
    }

    .area-tab .editing-field.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(107, 114, 128, 0.1);
    }

    .area-editing-form {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border: 1px solid var(--brand-primary);
      border-radius: 8px;
      padding: 12px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 300px;
    }

    .area-editing-form textarea {
      resize: vertical;
      min-height: 60px;
      margin: 8px 0;
    }

    .area-editing-form input[type="color"] {
      width: 40px;
      height: 32px;
      padding: 0;
      margin: 8px 0;
    }

    .context-menu-separator {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    .context-menu-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .no-tasks {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .no-tasks p {
      margin: 0 0 16px 0;
    }

    .task-detail-empty, .email-detail-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .btn.btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn.btn-outline {
      background: transparent;
      color: var(--brand-primary);
      border: 1px solid var(--brand-primary);
    }

    .btn.btn-outline:hover {
      background: var(--brand-primary);
      color: white;
    }

    /* Responsive adjustments for project management */
    @media (max-width: 768px) {
      .project-management {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 300px;  /* Tasks first, then compact navigator */
        gap: 16px;
      }
    }

    @media (max-width: 480px) {
      .project-management {
        gap: 12px;
      }
      
      .task-panel, .project-navigator {
        padding: 16px;
      }
    }

    /* Assessment flags with uniform height */
    .assessment-flag, .priority-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      min-width: 60px;
      height: 24px; /* Fixed height */
      line-height: 1;
      white-space: nowrap;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
    }

    .message.user {
      align-items: flex-end;
    }

    .message.agent {
      align-items: flex-start;
    }

    .message-content {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .message.user .message-content {
      background: var(--brand-primary);
      color: white;
    }

    .message.agent .message-content {
      background: var(--surface);
      color: var(--text-primary);
    }

    .message.thinking .message-content {
      background: none !important;
      color: var(--text-muted);
      opacity: 0.7;
      font-style: normal;
      text-align: left !important;
      padding: 0;
      border-radius: 0;
    }

    .message.agent .message-content {
      background: var(--surface);
      color: var(--text-primary);
    }

    /* Status messages should appear as plain text like thinking messages */
    .message.agent.status .message-content {
      background: none !important;
      color: var(--text-muted) !important;
      opacity: 0.7 !important;
      font-style: normal !important;
      text-align: left !important;
      padding: 0 !important;
      border-radius: 0 !important;
    }

    .message.thinking {
      align-items: flex-start !important;
      text-align: left !important;
      justify-content: flex-start !important;
    }

    .message.thinking * {
      text-align: left !important;
    }

    .message-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Input area */
    .input-area {
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--brand-primary);
    }

    .send-button {
      padding: 12px 16px;
      background: var(--brand-primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
    }

    .send-button:hover:not(:disabled) {
      background: var(--brand-hover);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Loading state */
    .loading-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: var(--bg-primary);
      color: var(--text-muted);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border, #334155);
      border-top: 3px solid var(--brand-primary, #3b82f6);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      min-width: 180px;
    }

    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .context-menu-item:hover {
      background: var(--surface-hover);
    }

    .context-menu-item:disabled {
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .context-menu-item:disabled:hover {
      background: none;
    }

    .context-menu-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

  </style>
</head>
<body>
  <div id="root">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <span>Loading Chief of Staff...</span>
    </div>
  </div>

  <script>
    const { useState, useEffect, useRef } = React;

    // Sample email data for demonstration
    const sampleEmails = [
      {
        id: 1,
        sender: "Sarah Johnson",
        sender_email: "sarah.johnson@company.com",
        subject: "Q4 Budget Review Meeting",
        preview: "Hi, I wanted to schedule our Q4 budget review meeting for next week. Are you available on Tuesday or Wednesday afternoon?",
        received_at: "2024-08-31T14:30:00Z",
        priority: "high",
        is_read: false,
        analysis: {
          key_points: ["Budget review meeting", "Q4 planning", "Scheduling request"],
          tone: "neutral",
          urgency_level: "high",
          requires_action: true,
          recommendations: [
            { action: "reply", confidence: 0.9, rationale: "Meeting request requires response" },
            { action: "schedule_meeting", confidence: 0.8, rationale: "Calendar scheduling needed" }
          ]
        }
      },
      {
        id: 2,
        sender: "Marketing Team",
        sender_email: "marketing@company.com",
        subject: "Campaign Performance Report - August 2024",
        preview: "Please find attached the comprehensive performance report for our August marketing campaigns. Overall engagement is up 23% compared to last month.",
        received_at: "2024-08-31T11:15:00Z",
        priority: "medium",
        is_read: false,
        analysis: {
          key_points: ["Performance report", "23% engagement increase", "August campaigns"],
          tone: "positive",
          urgency_level: "low",
          requires_action: false,
          recommendations: [
            { action: "read_later", confidence: 0.7, rationale: "Informational content for review" },
            { action: "archive", confidence: 0.6, rationale: "Can be archived after review" }
          ]
        }
      },
      {
        id: 3,
        sender: "IT Support",
        sender_email: "it-support@company.com",
        subject: "Security Update Required - Action Needed",
        preview: "URGENT: Please update your system password and enable two-factor authentication by end of day today. Click the link below to get started.",
        received_at: "2024-08-31T09:45:00Z",
        priority: "high",
        is_read: true,
        analysis: {
          key_points: ["Security update", "Password change", "2FA setup", "Deadline today"],
          tone: "urgent",
          urgency_level: "high",
          requires_action: true,
          recommendations: [
            { action: "create_task", confidence: 0.95, rationale: "Critical security task with deadline" },
            { action: "reply", confidence: 0.3, rationale: "May need IT support if issues arise" }
          ]
        }
      }
    ];

    function ChiefOfStaffApp() {
      console.log('ChiefOfStaffApp component initializing...');
      const [activeRoute, setActiveRoute] = useState('inbox');
      const [connectionStatus, setConnectionStatus] = useState('connecting');
      const [outlookStatus, setOutlookStatus] = useState('disconnected');
      const [usageStats, setUsageStats] = useState({
        calls_today: 0,
        total_calls: 0,
        estimated_cost: 0.0,
        cache_hit_rate: 0.0,
        api_calls: 0,
        mock_responses: 0
      });
      const [messages, setMessages] = useState([]);
      const [inputText, setInputText] = useState('');
      const [selectedEmail, setSelectedEmail] = useState(null);
      const [emails, setEmails] = useState([]);
      const [showFullRecipients, setShowFullRecipients] = useState(false);
      const [emailsLoading, setEmailsLoading] = useState(false);
      
      // Project Management state
      const [areas, setAreas] = useState([]);
      const [projects, setProjects] = useState([]);
      const [tasks, setTasks] = useState([]);
      const [selectedArea, setSelectedArea] = useState(null);
      const [selectedProject, setSelectedProject] = useState(null);
      
      // Area tabs state
      const [areaTabOrder, setAreaTabOrder] = useState([]);
      const [visibleTabsCount, setVisibleTabsCount] = useState(2);
      const [carouselOffset, setCarouselOffset] = useState(0);
      const [showOverflowMenu, setShowOverflowMenu] = useState(false);
      const [draggedTab, setDraggedTab] = useState(null);
      
      // Context menu state
      const [contextMenu, setContextMenu] = useState(null);
      const [showConfirmDialog, setShowConfirmDialog] = useState(null);
      const [selectedTask, setSelectedTask] = useState(null);
      const [projectsLoading, setProjectsLoading] = useState(false);
      const [expandedArchiveSections, setExpandedArchiveSections] = useState({
        projects: false,
        tasks: false
      });
      const [editingItems, setEditingItems] = useState({
        areas: new Set(),
        projects: new Set(), 
        tasks: new Set()
      });
      
      // State for saving items (prevent multiple concurrent saves)
      const [savingItems, setSavingItems] = useState({
        areas: new Set(),
        projects: new Set(),
        tasks: new Set()
      });
      
      const wsRef = useRef(null);
      const messagesEndRef = useRef(null);

      // Function to load recent emails
      const requestRecentEmails = () => {
        if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
          setEmailsLoading(true);
          
          // Add loading message to chat
          const loadingMessage = {
            id: Date.now() + '_loading',
            text: 'Loading emails...',
            timestamp: new Date().toISOString(),
            sender: 'system',
            isThinking: true,
            type: 'email_loading'
          };
          setMessages(prev => [...prev, loadingMessage]);
          
          // Clear emails list for gradual loading
          setEmails([]);
          
          wsRef.current.send(JSON.stringify({
            event: 'email:get_recent',
            data: { limit: 50, batch_size: 10 }
          }));
        }
      };

      // Project Management Functions
      const loadAreas = async () => {
        try {
          const response = await fetch('http://127.0.0.1:8787/api/areas');
          if (response.ok) {
            const areasData = await response.json();
            setAreas(areasData);
            return areasData;
          }
        } catch (error) {
          console.error('Failed to load areas:', error);
        }
      };

      const loadProjectsForArea = async (areaId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/areas/${areaId}/projects`);
          if (response.ok) {
            const projectsData = await response.json();
            setProjects(projectsData);
            return projectsData;
          }
        } catch (error) {
          console.error('Failed to load projects:', error);
        }
      };

      const loadTasksForProject = async (projectId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/projects/${projectId}`);
          if (response.ok) {
            const projectData = await response.json();
            setTasks(projectData.tasks || []);
            return projectData.tasks || [];
          }
        } catch (error) {
          console.error('Failed to load tasks:', error);
        }
      };

      const loadAllProjectData = async () => {
        setProjectsLoading(true);
        try {
          const areasData = await loadAreas();
          if (areasData && areasData.length > 0) {
            // Select first area by default and load its projects
            const firstArea = areasData[0];
            setSelectedArea(firstArea);
            const projectsData = await loadProjectsForArea(firstArea.id);
            if (projectsData && projectsData.length > 0) {
              // Select first project and load its tasks
              const firstProject = projectsData[0];
              setSelectedProject(firstProject);
              await loadTasksForProject(firstProject.id);
            }
          }
        } catch (error) {
          console.error('Failed to load project data:', error);
        } finally {
          setProjectsLoading(false);
        }
      };

      // Handle route changes and load emails when needed
      useEffect(() => {
        console.log('Route changed to:', activeRoute);
        
        // Load emails when user navigates to emails route and emails haven't been loaded yet
        if (activeRoute === 'emails' && emails.length === 0 && !emailsLoading) {
          console.log('📧 User navigated to emails - loading emails...');
          requestRecentEmails();
        }
        
        // Load project data when user navigates to projects route and data hasn't been loaded yet
        if (activeRoute === 'projects' && areas.length === 0 && !projectsLoading) {
          console.log('📋 User navigated to projects - loading project data...');
          loadAllProjectData();
        }
      }, [activeRoute, emails.length, emailsLoading, areas.length]);

      // WebSocket connection - Initialize on startup
      useEffect(() => {
        console.log('=== WEBSOCKET USEEFFECT STARTED ===');
        console.log('🔗 Initializing WebSocket connection on app startup...');
        try {
          console.log('WebSocket useEffect triggered - attempting connection');
          console.log('Attempting WebSocket connection to ws://127.0.0.1:8787/ws');
        const ws = new WebSocket('ws://127.0.0.1:8787/ws');
        wsRef.current = ws;
        // Make WebSocket globally available
        window.ws = ws;
        
        ws.onopen = () => {
          setConnectionStatus('connected');
          console.log('🔗 WebSocket connected successfully');
          // Request current status update
          console.log('📤 Requesting backend status...');
          ws.send(JSON.stringify({
            event: 'status:request',
            data: {}
          }));
        };
        
        ws.onclose = () => {
          setConnectionStatus('disconnected');
          console.log('WebSocket disconnected');
        };
        
        ws.onerror = (error) => {
          setConnectionStatus('disconnected');
          console.error('WebSocket error:', error);
        };
        
        ws.onmessage = (event) => {
          try {
            console.log('Raw WebSocket message received:', event.data);
            const message = JSON.parse(event.data);
            console.log('Parsed WebSocket message:', message);
            
            if (message.event === 'thread:append') {
              const newMessage = message.data.message;
              // Remove thinking message and add real response
              setMessages(prev => {
                const filtered = prev.filter(msg => !msg.isThinking);
                return [...filtered, newMessage];
              });
            } else if (message.event === 'email:list') {
              // Handle email list updates
              if (message.data && message.data.emails) {
                setEmails(message.data.emails);
              }
            } else if (message.event === 'email:load_progress') {
              // Handle loading progress updates
              console.log('Loading progress:', message.data);
              if (message.data) {
                const { status, current, total, message: progressMessage } = message.data;
                
                if (status === 'loading') {
                  // Update or add loading message
                  setMessages(prev => {
                    // Remove any existing loading messages
                    const filtered = prev.filter(msg => msg.type !== 'email_loading' && msg.type !== 'email_progress');
                    
                    // Add updated progress message
                    const progressMsg = {
                      id: 'email_progress_' + Date.now(),
                      text: progressMessage || `Loading ${current}/${total} emails...`,
                      timestamp: new Date().toISOString(),
                      sender: 'system',
                      type: 'email_progress',
                      isStatus: true
                    };
                    
                    return [...filtered, progressMsg];
                  });
                } else if (status === 'completed') {
                  // Remove loading messages when completed
                  setEmailsLoading(false);
                  setMessages(prev => prev.filter(msg => msg.type !== 'email_loading' && msg.type !== 'email_progress'));
                  
                  // Add completion message
                  const completionMessage = {
                    id: Date.now() + '_completed',
                    text: progressMessage || `✅ Loaded all ${total} emails successfully`,
                    timestamp: new Date().toISOString(),
                    sender: 'system',
                    isStatus: true
                  };
                  setMessages(prev => [...prev, completionMessage]);
                }
              }
            } else if (message.event === 'email:batch_loaded') {
              // Handle batched email loading
              console.log('Email batch loaded:', message.data);
              if (message.data && message.data.emails) {
                const batchEmails = message.data.emails;
                const { batch_start, is_final } = message.data;
                
                console.log(`📧 Processing batch ${batch_start}-${batch_start + batchEmails.length}, final: ${is_final}`);
                
                // Transform the batch emails to match our UI format
                const transformedBatch = batchEmails.map(item => {
                  const hasAnalysis = item.analysis && Object.keys(item.analysis).length > 0;
                  
                  const email = {
                    id: item.id,
                    subject: item.subject || 'No Subject',
                    sender: item.sender_name || item.sender_email,
                    preview: item.body_preview || 'No preview available',
                    received_at: item.received_at,
                    priority: hasAnalysis && item.analysis.priority ? item.analysis.priority : 'Unassessed',
                    tone: hasAnalysis && item.analysis.tone ? item.analysis.tone : 'Unassessed', 
                    urgency: hasAnalysis && item.analysis.urgency ? item.analysis.urgency : 'Unassessed',
                    recommendations: item.analysis?.recommendations || [],
                    to_recipients: item.to_recipients || [],
                    cc_recipients: item.cc_recipients || [],
                    bcc_recipients: item.bcc_recipients || [],
                    sender_name: item.sender_name,
                    sender_email: item.sender_email,
                    body_content: item.body_content || '',
                    body_preview: item.body_preview || '',
                    analysis: item.analysis
                  };
                  
                  return email;
                });
                
                // Add batch emails to existing list (append mode)
                setEmails(prev => [...prev, ...transformedBatch]);
                
                console.log(`📧 Added batch of ${transformedBatch.length} emails (total now: ${emails.length + transformedBatch.length})`);
              }
            } else if (message.event === 'email:recent_list') {
              // Handle recent emails with analysis
              console.log('Received email:recent_list event:', message);
              
              // Remove email loading message and update loading state
              setEmailsLoading(false);
              setMessages(prev => prev.filter(msg => msg.type !== 'email_loading'));
              
              if (message.data && message.data.emails) {
                console.log('Raw email data:', message.data.emails);
                // Transform the analyzed emails to match our UI format - INCLUDE RECIPIENT FIELDS
                const transformedEmails = message.data.emails.map(item => {
                  // Check if analysis exists and has been actually assessed
                  const hasAnalysis = item.analysis && Object.keys(item.analysis).length > 0;
                  
                  const email = {
                    id: item.id,
                    subject: item.subject || 'No Subject',
                    sender: item.sender_name || item.sender_email,
                    preview: item.body_preview || 'No preview available',
                    received_at: item.received_at,
                    // Use actual values or 'Unassessed' if no real analysis
                    priority: hasAnalysis && item.analysis.priority ? item.analysis.priority : 'Unassessed',
                    tone: hasAnalysis && item.analysis.tone ? item.analysis.tone : 'Unassessed', 
                    urgency: hasAnalysis && item.analysis.urgency ? item.analysis.urgency : 'Unassessed',
                    recommendations: item.analysis?.recommendations || [],
                    // Add recipient fields that were missing
                    to_recipients: item.to_recipients || [],
                    cc_recipients: item.cc_recipients || [],
                    bcc_recipients: item.bcc_recipients || [],
                    // Also preserve original sender fields for debugging
                    sender_name: item.sender_name,
                    sender_email: item.sender_email,
                    // CRITICAL: Preserve full body content for email detail view
                    body_content: item.body_content || '',
                    body_preview: item.body_preview || '',
                    // Preserve full analysis for detailed view
                    analysis: item.analysis
                  };
                  
                  // Debug log for first few emails
                  if (item.id === message.data.emails[0].id || item.id === message.data.emails[1]?.id) {
                    console.log(`📧 Email "${email.subject.substring(0,30)}..." - Priority: ${email.priority}, Analysis:`, !!item.analysis);
                  }
                  
                  return email;
                });
                setEmails(transformedEmails);
                
                // Add success message to chat
                const successMessage = {
                  id: Date.now() + '_success',
                  text: `📧 Loaded ${transformedEmails.length} emails successfully`,
                  timestamp: new Date().toISOString(),
                  sender: 'system',
                  isStatus: true
                };
                setMessages(prev => [...prev, successMessage]);
                
                console.log('📧 EMAILS LOADED:', {
                  count: transformedEmails.length,
                  sample_email: transformedEmails[0] ? {
                    id: transformedEmails[0].id,
                    subject: transformedEmails[0].subject?.substring(0, 50),
                    has_to_recipients: transformedEmails[0].to_recipients ? transformedEmails[0].to_recipients.length : 0,
                    has_cc_recipients: transformedEmails[0].cc_recipients ? transformedEmails[0].cc_recipients.length : 0,
                    keys: Object.keys(transformedEmails[0])
                  } : 'none'
                });
                console.log('Loaded', transformedEmails.length, 'emails from Outlook');
              } else {
                console.log('No email data in response:', message);
              }
            } else if (message.event === 'status:outlook' || message.event === 'outlook:connected') {
              // Handle outlook status updates
              if (message.data && message.data.status) {
                setOutlookStatus(message.data.status);
              } else if (message.event === 'outlook:connected') {
                setOutlookStatus('connected');
              }
            } else if (message.event === 'status:usage') {
              // Handle usage statistics updates
              if (message.data) {
                setUsageStats(message.data);
                console.log('Usage stats updated:', message.data);
              }
            } else if (message.event === 'email:analyzed') {
              // Handle email analysis results
              if (message.data && message.data.email_id) {
                const analysis = message.data.analysis;
                console.log('📧 Email analysis received:', analysis);
                
                // Extract analysis fields for UI display
                const analysisUpdate = {
                  analysis: analysis,
                  priority: analysis.priority || 'Unassessed',
                  tone: analysis.tone || 'Unassessed', 
                  urgency: analysis.urgency || 'Unassessed',
                  recommendations: analysis.suggested_actions || analysis.recommendations || [],
                  isProcessing: false
                };
                
                console.log('🔍 ANALYSIS UPDATE DEBUG:', {
                  email_id: message.data.email_id,
                  analysis_summary: analysis.summary,
                  analysis_keys: Object.keys(analysis),
                  full_analysis_update: analysisUpdate
                });
                
                // Debug ID matching
                console.log('🔍 ID MATCHING DEBUG:', {
                  selectedEmail_exists: !!selectedEmail,
                  selectedEmail_id: selectedEmail?.id,
                  analyzed_email_id: message.data.email_id,
                  ids_match: selectedEmail?.id === message.data.email_id,
                  selectedEmail_id_length: selectedEmail?.id?.length,
                  analyzed_email_id_length: message.data.email_id?.length
                });
                
                // Update the selected email with analysis results using functional updates
                setSelectedEmail(currentSelectedEmail => {
                  console.log('🔄 FUNCTIONAL UPDATE - Current selectedEmail:', {
                    exists: !!currentSelectedEmail,
                    id: currentSelectedEmail?.id,
                    subject: currentSelectedEmail?.subject?.substring(0, 50)
                  });
                  
                  if (currentSelectedEmail && currentSelectedEmail.id === message.data.email_id) {
                    const updatedEmail = {
                      ...currentSelectedEmail,
                      ...analysisUpdate
                    };
                    console.log('🔄 UPDATING SELECTED EMAIL (DIRECT MATCH):', {
                      before_analysis: currentSelectedEmail.analysis?.summary?.substring(0, 50),
                      after_analysis: updatedEmail.analysis?.summary?.substring(0, 50),
                      analysis_object_keys: updatedEmail.analysis ? Object.keys(updatedEmail.analysis) : 'no analysis'
                    });
                    return updatedEmail;
                  } else if (currentSelectedEmail) {
                    // Fallback: Try to find the analyzed email in the emails list and check if it matches by subject/content
                    const analyzedEmailFromList = emails.find(e => e.id === message.data.email_id);
                    if (analyzedEmailFromList && 
                        (analyzedEmailFromList.subject === currentSelectedEmail.subject || 
                         analyzedEmailFromList.sender === currentSelectedEmail.sender)) {
                      console.log('🔄 UPDATING SELECTED EMAIL (FALLBACK MATCH):', {
                        reason: 'ID mismatch but subject/sender match',
                        selected_id: currentSelectedEmail.id,
                        analyzed_id: message.data.email_id,
                        subject_match: analyzedEmailFromList.subject === currentSelectedEmail.subject
                      });
                      const updatedEmail = {
                        ...currentSelectedEmail,
                        ...analysisUpdate,
                        id: message.data.email_id // Update with correct ID
                      };
                      return updatedEmail;
                    } else {
                      console.log('❌ SELECTED EMAIL NOT UPDATED (FALLBACK FAILED):', {
                        reason: 'No subject/sender match',
                        selected_id: currentSelectedEmail?.id,
                        analyzed_id: message.data.email_id,
                        selected_subject: currentSelectedEmail?.subject?.substring(0, 30),
                        analyzed_email_found: !!analyzedEmailFromList,
                        analyzed_subject: analyzedEmailFromList?.subject?.substring(0, 30)
                      });
                      return currentSelectedEmail; // No change
                    }
                  } else {
                    // No selected email at all - try to find and select the analyzed email
                    const analyzedEmailFromList = emails.find(e => e.id === message.data.email_id);
                    if (analyzedEmailFromList) {
                      console.log('🔄 SELECTING ANALYZED EMAIL (NO SELECTION):', {
                        reason: 'No email selected, selecting the analyzed one',
                        analyzed_id: message.data.email_id,
                        analyzed_subject: analyzedEmailFromList.subject?.substring(0, 50)
                      });
                      return {
                        ...analyzedEmailFromList,
                        ...analysisUpdate
                      };
                    } else {
                      console.log('❌ NO EMAIL TO UPDATE:', {
                        reason: 'No selected email and analyzed email not found in list',
                        analyzed_id: message.data.email_id,
                        emails_count: emails.length
                      });
                      return currentSelectedEmail; // No change
                    }
                  }
                });
                // Also update the email in the emails array
                setEmails(prevEmails => 
                  prevEmails.map(email => 
                    email.id === message.data.email_id 
                      ? { ...email, ...analysisUpdate }
                      : email
                  )
                );
                
                // Add success notification to chat
                const email = emails.find(e => e.id === message.data.email_id);
                const successMessage = {
                  id: Date.now() + '_analysis_complete',
                  text: `✅ Analysis complete for: "${email?.subject?.substring(0, 50) || 'Email'}" - Priority: ${analysis.priority}, Tone: ${analysis.tone}`,
                  timestamp: new Date().toISOString(),
                  sender: 'system'
                };
                setMessages(prev => [...prev, successMessage]);
                
                console.log('✅ Email analysis updated in UI for:', message.data.email_id);
              }
            }
          } catch (error) {
            console.error('Error parsing WebSocket message:', error);
          }
        };
        
        return () => {
          if (wsRef.current) {
            wsRef.current.close();
          }
        };
        } catch (error) {
          console.error('Error in WebSocket useEffect:', error);
        }
      }, []);

      // Auto-scroll to bottom of messages
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      // Initialize area tab order when areas are loaded
      useEffect(() => {
        if (areas.length > 0 && areaTabOrder.length === 0) {
          setAreaTabOrder(areas.map(area => area.id));
        }
      }, [areas, areaTabOrder.length]);

      // Reset carousel offset when areas change to prevent out-of-bounds
      useEffect(() => {
        const maxOffset = Math.max(0, areas.length - visibleTabsCount);
        if (carouselOffset > maxOffset) {
          setCarouselOffset(maxOffset);
        }
      }, [areas.length, carouselOffset, visibleTabsCount]);

      // Close overflow menu on outside click
      useEffect(() => {
        const handleOutsideClick = (event) => {
          if (showOverflowMenu && !event.target.closest('.area-overflow-menu')) {
            setShowOverflowMenu(false);
          }
        };

        if (showOverflowMenu) {
          document.addEventListener('click', handleOutsideClick);
          return () => document.removeEventListener('click', handleOutsideClick);
        }
      }, [showOverflowMenu]);

      // Handle context menu interactions
      useEffect(() => {
        const handleClick = () => setContextMenu(null);
        const handleScroll = () => setContextMenu(null);
        
        if (contextMenu) {
          document.addEventListener('click', handleClick);
          document.addEventListener('scroll', handleScroll, true);
          return () => {
            document.removeEventListener('click', handleClick);
            document.removeEventListener('scroll', handleScroll, true);
          };
        }
      }, [contextMenu]);

      const handleContextMenuAction = (action, email) => {
        setContextMenu(null);
        
        if (action === 'reprocess' && email && !email.isProcessing) {
          // Force re-analysis by clearing existing analysis first
          const emailForReprocessing = { ...email, analysis: null, priority: 'Unassessed' };
          setSelectedEmail(emailForReprocessing);
          
          // Set processing state for both email list and selected email
          setEmails(prevEmails => 
            prevEmails.map(e => 
              e.id === email.id 
                ? { ...e, isProcessing: true, analysis: null, priority: 'Unassessed' }
                : e
            )
          );
          setSelectedEmail(prev => prev ? { ...prev, isProcessing: true, analysis: null, priority: 'Unassessed' } : prev);
          
          // Send analysis request
          if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
            const message = {
              event: 'email:analyze',
              data: {
                email_id: email.id,
                subject: email.subject || '',
                content: email.body_content || email.content || email.preview || '',
                sender: email.sender || '',
                sender_name: email.sender_name || ''
              }
            };
            wsRef.current.send(JSON.stringify(message));
            console.log('🔄 Re-processing email with AI:', email.id);
          }
        }
      };

      const sendMessage = () => {
        if (!inputText.trim() || connectionStatus !== 'connected' || !wsRef.current) return;
        
        const userMessage = {
          id: Date.now(),
          role: 'user',
          content: inputText,
          timestamp: new Date().toISOString()
        };
        
        setMessages(prev => [...prev, userMessage]);
        
        // Add thinking indicator
        const thinkingMessage = {
          id: Date.now() + 1,
          role: 'assistant',
          content: 'Thinking...',
          timestamp: new Date().toISOString(),
          isThinking: true
        };
        setMessages(prev => [...prev, thinkingMessage]);
        
        wsRef.current.send(JSON.stringify({
          event: 'thread:send',
          data: {
            text: inputText,
            timestamp: new Date().toISOString()
          }
        }));
        
        setInputText('');
      };


      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      const handleEmailSelect = (email) => {
        console.log('🎯 EMAIL SELECTED:', {
          email_id: email?.id,
          email_subject: email?.subject,
          email_keys: email ? Object.keys(email) : 'null',
          has_recipients: {
            to_recipients: email?.to_recipients ? email.to_recipients.length : 0,
            cc_recipients: email?.cc_recipients ? email.cc_recipients.length : 0,
            bcc_recipients: email?.bcc_recipients ? email.bcc_recipients.length : 0
          },
          current_selected: selectedEmail?.id
        });
        setSelectedEmail(email);
        
        // Auto-trigger email analysis if not already analyzed
        console.log(`🔍 Email selected: "${email?.subject?.substring(0,30)}..." - Priority: ${email?.priority}, Analysis:`, !!email?.analysis);
        if (email && (!email.analysis || email.priority === 'Unassessed')) {
          console.log('🔄 Auto-triggering email analysis for:', email.id);
          
          // Set processing state for this email in the list
          setEmails(prevEmails => 
            prevEmails.map(e => 
              e.id === email.id 
                ? { ...e, isProcessing: true }
                : e
            )
          );
          
          // Also set processing state for the selected email (for Summary panel)
          setSelectedEmail(prev => prev ? { ...prev, isProcessing: true } : prev);
          
          if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
            const message = {
              event: 'email:analyze',
              data: { 
                email_id: email.id,
                subject: email.subject,
                content: email.preview || email.body_content || '',
                sender: email.sender
              }
            };
            wsRef.current.send(JSON.stringify(message));
          }
        }
      };

      const formatTime = (timestamp) => {
        return new Date(timestamp).toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
      };

      // Helper function to get assessment flag colors and text colors
      const getPriorityText = (priority) => {
        // Convert numeric priority (1-5) to text
        switch (parseInt(priority)) {
          case 1: return 'Ultra';
          case 2: return 'High';
          case 3: return 'Medium';
          case 4: return 'Low';
          case 5: return 'Base';
          default: return 'Medium';
        }
      };

      const getAssessmentStyle = (type, value) => {
        // Always show "Unassessed" in grey
        if (value === 'Unassessed' || !value) {
          return { 
            background: '#e5e7eb', 
            color: '#6b7280',
            border: '1px solid #d1d5db'
          };
        }
        
        // Make case-insensitive for consistency
        const lowerValue = value.toLowerCase();
        
        // Priority levels: 🟢 Base/Low (green) -> 🟠 Medium (amber) -> 🔴 High/Ultra (red)
        if (type === 'priority') {
          if (lowerValue === 'ultra' || lowerValue === 'high') return { background: '#fecaca', color: '#dc2626', border: '1px solid #fca5a5' };
          if (lowerValue === 'medium') return { background: '#fed7aa', color: '#ea580c', border: '1px solid #fdba74' };
          if (lowerValue === 'low' || lowerValue === 'base') return { background: '#bbf7d0', color: '#059669', border: '1px solid #86efac' };
        }
        
        // Urgency levels: 🟢 Low (green) -> 🟠 Medium (amber) -> 🔴 High/Immediate (red)
        if (type === 'urgency') {
          if (lowerValue === 'high' || lowerValue === 'urgent' || lowerValue === 'immediate') {
            return { background: '#fecaca', color: '#dc2626', border: '1px solid #fca5a5' };
          }
          if (lowerValue === 'medium' || lowerValue === 'moderate') {
            return { background: '#fed7aa', color: '#ea580c', border: '1px solid #fdba74' };
          }
          if (lowerValue === 'low') {
            return { background: '#bbf7d0', color: '#059669', border: '1px solid #86efac' };
          }
        }
        
        // Tone: contextual colors based on tone type
        if (type === 'tone') {
          if (lowerValue === 'urgent' || lowerValue === 'aggressive') {
            return { background: '#fecaca', color: '#dc2626', border: '1px solid #fca5a5' };
          }
          if (lowerValue === 'formal' || lowerValue === 'professional') {
            return { background: '#dbeafe', color: '#2563eb', border: '1px solid #bfdbfe' };
          }
          if (lowerValue === 'friendly' || lowerValue === 'casual') {
            return { background: '#bbf7d0', color: '#059669', border: '1px solid #86efac' };
          }
          if (lowerValue === 'neutral') {
            return { background: '#f3f4f6', color: '#4b5563', border: '1px solid #d1d5db' };
          }
          if (lowerValue === 'positive') {
            return { background: '#bbf7d0', color: '#059669', border: '1px solid #86efac' };
          }
          if (lowerValue === 'negative' || lowerValue === 'concerned') {
            return { background: '#fecaca', color: '#dc2626', border: '1px solid #fca5a5' };
          }
          // Other tones get a purple treatment
          return { background: '#e9d5ff', color: '#7c3aed', border: '1px solid #c4b5fd' };
        }
        
        // Default fallback - grey for unknown values
        return { background: '#f3f4f6', color: '#4b5563', border: '1px solid #d1d5db' };
      };

      const formatDate = (timestamp) => {
        if (!timestamp || timestamp === 'unknown' || timestamp === '') {
          return 'Unknown date';
        }
        
        const date = new Date(timestamp);
        
        // Check if date is invalid
        if (isNaN(date.getTime())) {
          return 'Invalid date';
        }
        
        const now = new Date();
        
        // Check if it's the same day (today)
        const isToday = date.toDateString() === now.toDateString();
        
        if (isToday) {
          // Show just time for today's emails
          return formatTime(timestamp);
        } else {
          // Check if it's yesterday
          const yesterday = new Date(now);
          yesterday.setDate(now.getDate() - 1);
          const isYesterday = date.toDateString() === yesterday.toDateString();
          
          if (isYesterday) {
            return `Yesterday ${formatTime(timestamp)}`;
          } else {
            // For older emails, show date and time
            const currentYear = now.getFullYear();
            const emailYear = date.getFullYear();
            
            if (emailYear === currentYear) {
              // Same year: show "Mon, Jan 15 10:30 AM"
              return `${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} ${formatTime(timestamp)}`;
            } else {
              // Different year: show "Jan 15, 2024 10:30 AM"
              return `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} ${formatTime(timestamp)}`;
            }
          }
        }
      };

      // Area tabs utility functions
      const getOrderedAreas = () => {
        if (areaTabOrder.length === 0) return areas;
        return areaTabOrder.map(id => areas.find(area => area.id === id)).filter(Boolean);
      };

      const getVisibleAreas = () => {
        const ordered = getOrderedAreas();
        return ordered.slice(carouselOffset, carouselOffset + visibleTabsCount);
      };

      const getOverflowAreas = () => {
        // No overflow areas - carousel handles all navigation
        return [];
      };

      const canScrollLeft = () => carouselOffset > 0;
      
      const canScrollRight = () => {
        const ordered = getOrderedAreas();
        return carouselOffset + visibleTabsCount < ordered.length;
      };
      
      const scrollCarouselLeft = () => {
        if (canScrollLeft()) {
          setCarouselOffset(Math.max(0, carouselOffset - 1));
        }
      };
      
      const scrollCarouselRight = () => {
        const ordered = getOrderedAreas();
        if (canScrollRight()) {
          setCarouselOffset(Math.min(ordered.length - visibleTabsCount, carouselOffset + 1));
        }
      };

      const moveAreaTab = (fromIndex, toIndex) => {
        const newOrder = [...areaTabOrder];
        const [moved] = newOrder.splice(fromIndex, 1);
        newOrder.splice(toIndex, 0, moved);
        setAreaTabOrder(newOrder);
      };

      const handleAreaTabSelect = async (area) => {
        try {
          setSelectedArea(area);
          setSelectedProject(null);
          setTasks([]);
          const projectsData = await loadProjectsForArea(area.id);
          if (projectsData && projectsData.length > 0) {
            const firstProject = projectsData[0];
            setSelectedProject(firstProject);
            await loadTasksForProject(firstProject.id);
          }
        } catch (error) {
          console.error('Error loading area projects:', error);
        }
      };

      // Project display utility functions
      const getSortedProjects = (projectsList) => {
        if (!projectsList) return [];
        
        // Sort projects: catch-all "Tasks" first, then others alphabetically
        return [...projectsList].sort((a, b) => {
          // Catch-all projects first
          if (a.is_catch_all && !b.is_catch_all) return -1;
          if (!a.is_catch_all && b.is_catch_all) return 1;
          
          // Then sort alphabetically
          return a.name.localeCompare(b.name);
        });
      };

      const getProjectDisplayName = (project, area) => {
        // Rename catch-all "Tasks" projects to "Area Tasks"
        if (project.is_catch_all && project.name === 'Tasks') {
          return `${area?.name || 'Area'} Tasks`;
        }
        return project.name;
      };
      
      const getStatusDisplayText = (status) => {
        const statusMap = {
          'not_started': 'Not Started',
          'in_progress': 'In Progress', 
          'active': 'Active',
          'blocked': 'Blocked',
          'completed': 'Completed',
          'dropped': 'Dropped',
          'paused': 'Paused',
          'planning': 'Planning',
          'archived': 'Archived'
        };
        return statusMap[status] || status;
      };
      
      const formatCount = (count) => {
        const num = Number(count) || 0;
        return num > 99 ? ':)' : String(num);
      };

      // Context menu helper functions
      const showContextMenu = (event, type, item) => {
        event.preventDefault();
        event.stopPropagation();
        setContextMenu({
          x: event.pageX,
          y: event.pageY,
          type,
          item
        });
      };

      const showConfirmationDialog = (config) => {
        setShowConfirmDialog(config);
      };

      const hideConfirmationDialog = () => {
        setShowConfirmDialog(null);
      };

      const toggleArchiveSection = (section) => {
        setExpandedArchiveSections(prev => ({
          ...prev,
          [section]: !prev[section]
        }));
      };

      // Inline editing helpers
      const createNewArea = async () => {
        const tempId = `temp_${Date.now()}`;
        const newArea = {
          id: tempId,
          name: "New Area",
          description: "Area description",
          color: "#6366F1",
          is_editing: true,
          is_new: true
        };

        setAreas(prev => [...prev, newArea]);
        setEditingItems(prev => ({
          ...prev,
          areas: new Set([...prev.areas, tempId])
        }));

        // Focus the name field after render
        setTimeout(() => {
          const nameField = document.querySelector(`input[data-field="area-name-${tempId}"]`);
          if (nameField) {
            nameField.select();
          }
        }, 50);
      };

      const createNewProject = async () => {
        if (!selectedArea) return;
        
        const tempId = `temp_${Date.now()}`;
        const newProject = {
          id: tempId,
          name: "New Project",
          description: "Project description",
          status: "active",
          priority: 3,
          area_id: selectedArea.id,
          is_editing: true,
          is_new: true,
          task_count: 0
        };

        setProjects(prev => [...prev, newProject]);
        setEditingItems(prev => ({
          ...prev,
          projects: new Set([...prev.projects, tempId])
        }));

        setTimeout(() => {
          const nameField = document.querySelector(`input[data-field="project-name-${tempId}"]`);
          if (nameField) {
            nameField.select();
          }
        }, 50);
      };

      const createNewTask = async () => {
        if (!selectedProject) return;
        
        const tempId = `temp_${Date.now()}`;
        const newTask = {
          id: tempId,
          title: "New Task",
          objective: "What needs to be accomplished",
          status: "not_started",
          priority: 3,
          project_id: selectedProject.id,
          sponsor_email: "",
          owner_email: "",
          is_editing: true,
          is_new: true
        };

        setTasks(prev => [newTask, ...prev]);
        setEditingItems(prev => ({
          ...prev,
          tasks: new Set([...prev.tasks, tempId])
        }));

        setTimeout(() => {
          const titleField = document.querySelector(`input[data-field="task-title-${tempId}"]`);
          if (titleField) {
            titleField.select();
          }
        }, 50);
      };

      const saveItem = async (type, item) => {
        console.log(`🔄 saveItem called: type=${type}, itemId=${item?.id}, item=`, item);
        
        // Prevent multiple concurrent saves for the same item
        const itemKey = item.id;
        const typeKey = type + 's';
        
        if (savingItems[typeKey].has(itemKey)) {
          console.log(`Already saving ${type} ${itemKey}, ignoring duplicate save request`);
          return;
        }
        
        // Mark item as being saved
        setSavingItems(prev => ({
          ...prev,
          [typeKey]: new Set([...prev[typeKey], itemKey])
        }));
        
        try {
          let response;
          const itemData = { ...item };
          delete itemData.is_editing;
          
          const isNewItem = item.is_new || item.id.startsWith('temp_');
          delete itemData.is_new;
          
          // For task updates, don't send read-only fields
          if (type === 'task' && !isNewItem) {
            delete itemData.created_at;  // Don't update created_at on existing tasks
            delete itemData.updated_at;  // Backend will set this automatically
          }
          
          console.log(`🔍 Processing save: type=${type}, isNewItem=${isNewItem}, itemData=`, itemData);
          
          if (isNewItem) {
            // Creating new item - use POST and let backend generate ID
            delete itemData.id;
            
            if (type === 'area') {
              response = await fetch('http://127.0.0.1:8787/api/areas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
              });
            } else if (type === 'project') {
              response = await fetch('http://127.0.0.1:8787/api/projects', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
              });
            } else if (type === 'task') {
              response = await fetch('http://127.0.0.1:8787/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
              });
            }
          } else {
            // Updating existing item - use PUT with ID in URL
            const itemId = itemData.id;
            delete itemData.id; // Don't send ID in body
            
            if (type === 'area') {
              response = await fetch(`http://127.0.0.1:8787/api/areas/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
              });
            } else if (type === 'project') {
              response = await fetch(`http://127.0.0.1:8787/api/projects/${itemId}`, {
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
              });
            } else if (type === 'task') {
              console.log(`Sending PUT request for task ${itemId} with data:`, itemData);
              response = await fetch(`http://127.0.0.1:8787/api/tasks/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
              });
              const responseData = await response.clone().json();
              console.log(`PUT response for task ${itemId}:`, responseData);
            }
          }

          if (response && response.ok) {
            // For successful saves, keep the current local state instead of reloading from server
            // This ensures the UI shows the updated values immediately
            console.log(`Successfully saved ${type} ${item.id} (isNewItem: ${isNewItem})`);
            
            // Always reload from server to confirm the save worked and get latest data
            console.log(`Reloading ${type} data to confirm save (isNewItem: ${isNewItem})`);
            if (type === 'area') {
              await loadAreas();
            } else if (type === 'project') {
              await loadProjectsForArea(selectedArea.id);
            } else if (type === 'task') {
              await loadTasksForProject(selectedProject.id);
              // Also reload project data to update task counts
              await loadProjectsForArea(selectedArea.id);
            }
            
            // Clear editing state
            setEditingItems(prev => ({
              ...prev,
              [type + 's']: new Set([...prev[type + 's']].filter(id => id !== item.id))
            }));
          } else {
            const errorText = response ? await response.text() : 'No response';
            console.error(`Failed to save ${type}:`, errorText);
            
            // Show user-friendly error message for areas
            if (type === 'area') {
              try {
                const errorData = JSON.parse(errorText);
                alert(errorData.error || 'Failed to save area');
              } catch {
                alert('Failed to save area: ' + errorText);
              }
            }
          }
        } catch (error) {
          console.error(`Error saving ${type}:`, error);
        } finally {
          // Always clear saving state, even on error
          setSavingItems(prev => ({
            ...prev,
            [typeKey]: new Set([...prev[typeKey]].filter(id => id !== itemKey))
          }));
        }
      };

      const cancelEdit = (type, itemId) => {
        // Remove from editing state
        setEditingItems(prev => ({
          ...prev,
          [type + 's']: new Set([...prev[type + 's']].filter(id => id !== itemId))
        }));

        // Remove temp items
        if (itemId.startsWith('temp_')) {
          if (type === 'area') {
            setAreas(prev => prev.filter(a => a.id !== itemId));
          } else if (type === 'project') {
            setProjects(prev => prev.filter(p => p.id !== itemId));
          } else if (type === 'task') {
            setTasks(prev => prev.filter(t => t.id !== itemId));
          }
        }
      };

      const startEditingItem = (type, itemId) => {
        // Add to editing state
        setEditingItems(prev => ({
          ...prev,
          [type + 's']: new Set([...prev[type + 's'], itemId])
        }));

        // Focus the appropriate field after render
        setTimeout(() => {
          let fieldSelector;
          if (type === 'area') {
            fieldSelector = `input[data-field="area-name-${itemId}"]`;
          } else if (type === 'project') {
            fieldSelector = `input[data-field="project-name-${itemId}"]`;
          } else if (type === 'task') {
            fieldSelector = `input[data-field="task-title-${itemId}"]`;
          }
          
          const field = document.querySelector(fieldSelector);
          if (field) {
            field.focus();
            field.select();
          }
        }, 50);
      };

      const hideContextMenu = () => {
        setContextMenu(null);
      };

      // Archive/delete functions
      const archiveProject = async (projectId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/projects/${projectId}/archive`, {
            method: 'PUT'
          });
          const result = await response.json();
          if (result.success) {
            // Reload project data
            await loadProjectsForArea(selectedArea.id);
            await loadTasksForProject(selectedProject?.id);
          } else {
            console.error('Failed to archive project:', result.error);
          }
        } catch (error) {
          console.error('Error archiving project:', error);
        }
      };

      const restoreProject = async (projectId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/projects/${projectId}/restore`, {
            method: 'PUT'
          });
          const result = await response.json();
          if (result.success) {
            // Reload project data
            await loadProjectsForArea(selectedArea.id);
            await loadTasksForProject(selectedProject?.id);
          } else {
            console.error('Failed to restore project:', result.error);
          }
        } catch (error) {
          console.error('Error restoring project:', error);
        }
      };

      const deleteProject = async (projectId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/projects/${projectId}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          if (result.success) {
            // Reload project data
            await loadProjectsForArea(selectedArea.id);
            setSelectedProject(null);
            setTasks([]);
          } else {
            console.error('Failed to delete project:', result.error);
          }
        } catch (error) {
          console.error('Error deleting project:', error);
        }
      };

      const deleteArea = async (areaId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/areas/${areaId}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          if (result.success) {
            // Reload areas data
            await loadAreas();
            // If the deleted area was selected, clear selection
            if (selectedArea?.id === areaId) {
              setSelectedArea(null);
              setProjects([]);
              setSelectedProject(null);
              setTasks([]);
            }
          } else {
            console.error('Failed to delete area:', result.error);
            // Show user-friendly error message
            alert(result.error);
          }
        } catch (error) {
          console.error('Error deleting area:', error);
          alert('Failed to delete area: ' + error.message);
        }
      };

      const archiveTask = async (taskId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/tasks/${taskId}/archive`, {
            method: 'PUT'
          });
          const result = await response.json();
          if (result.success) {
            // Reload tasks and project data to update counts
            await loadTasksForProject(selectedProject.id);
            await loadProjectsForArea(selectedArea.id);
          } else {
            console.error('Failed to archive task:', result.error);
          }
        } catch (error) {
          console.error('Error archiving task:', error);
        }
      };

      const deleteTask = async (taskId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/tasks/${taskId}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          if (result.success) {
            // Reload tasks and project data to update counts
            await loadTasksForProject(selectedProject.id);
            await loadProjectsForArea(selectedArea.id);
            if (selectedTask?.id === taskId) {
              setSelectedTask(null);
            }
          } else {
            console.error('Failed to delete task:', result.error);
          }
        } catch (error) {
          console.error('Error deleting task:', error);
        }
      };

      const restoreTask = async (taskId) => {
        try {
          const response = await fetch(`http://127.0.0.1:8787/api/tasks/${taskId}/restore`, {
            method: 'PUT'
          });
          const result = await response.json();
          if (result.success) {
            // Reload tasks and project data to update counts
            await loadTasksForProject(selectedProject.id);
            await loadProjectsForArea(selectedArea.id);
          } else {
            console.error('Failed to restore task:', result.error);
          }
        } catch (error) {
          console.error('Error restoring task:', error);
        }
      };

      // Context menu component
      const renderContextMenu = () => {
        if (!contextMenu) return null;

        const getContextMenuItems = () => {
          switch (contextMenu.type) {
            case 'project':
              const project = contextMenu.item;
              if (project.status === 'archived') {
                return [
                  { label: 'Restore Project', action: () => restoreProject(project.id) },
                  { label: 'separator' },
                  { label: 'Delete Permanently', action: () => showConfirmationDialog({
                    type: 'danger',
                    title: 'Delete Project Permanently',
                    message: `Are you sure you want to permanently delete "${project.name}"? This action cannot be undone.`,
                    confirmText: 'Delete Permanently',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                      deleteProject(project.id);
                      hideConfirmationDialog();
                    },
                    onCancel: hideConfirmationDialog
                  }), destructive: true }
                ];
              } else {
                const items = [
                  { label: 'Edit Project', action: () => startEditingItem('project', project.id) }
                ];
                
                // Only allow archive for non-system projects
                if (!project.is_system) {
                  items.push(
                    { label: 'separator' },
                    { label: 'Archive Project', action: () => showConfirmationDialog({
                      type: 'warning',
                      title: 'Archive Project',
                      message: `Are you sure you want to archive "${project.name}"? It will be moved to the archived section and can be restored later.`,
                      confirmText: 'Archive Project',
                      cancelText: 'Cancel',
                      onConfirm: () => {
                        archiveProject(project.id);
                        hideConfirmationDialog();
                      },
                      onCancel: hideConfirmationDialog
                    }), destructive: true }
                  );
                }
                
                return items;
              }
              
            case 'task':
              const task = contextMenu.item;
              if (task.status === 'archived') {
                return [
                  { label: 'Restore Task', action: () => restoreTask(task.id) },
                  { label: 'separator' },
                  { label: 'Delete Permanently', action: () => showConfirmationDialog({
                    type: 'danger',
                    title: 'Delete Task Permanently',
                    message: `Are you sure you want to permanently delete "${task.title}"? This action cannot be undone.`,
                    confirmText: 'Delete Permanently',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                      deleteTask(task.id);
                      hideConfirmationDialog();
                    },
                    onCancel: hideConfirmationDialog
                  }), destructive: true }
                ];
              } else {
                return [
                  { label: 'Edit Task', action: () => startEditingItem('task', task.id) },
                  { label: 'separator' },
                  { label: 'Archive Task', action: () => showConfirmationDialog({
                    type: 'warning',
                    title: 'Archive Task',
                    message: `Are you sure you want to archive "${task.title}"? It will be moved to the archived section and can be restored later.`,
                    confirmText: 'Archive Task',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                      archiveTask(task.id);
                      hideConfirmationDialog();
                    },
                    onCancel: hideConfirmationDialog
                  }) },
                  { label: 'Delete Task', action: () => showConfirmationDialog({
                    type: 'danger',
                    title: 'Delete Task',
                    message: `Are you sure you want to delete "${task.title}"? This action cannot be undone.`,
                    confirmText: 'Delete Task',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                      deleteTask(task.id);
                      hideConfirmationDialog();
                    },
                    onCancel: hideConfirmationDialog
                  }), destructive: true }
                ];
              }
              
            case 'area':
              const area = contextMenu.item;
              return [
                { label: 'Edit Area', action: () => startEditingItem('area', area.id) },
                { label: 'separator' },
                { label: 'Delete Area', action: () => deleteArea(area.id), destructive: true }
              ];
              
            default:
              return [];
          }
        };

        const menuItems = getContextMenuItems();

        return React.createElement('div', {
          className: 'context-menu',
          style: {
            left: contextMenu.x,
            top: contextMenu.y
          },
          onMouseLeave: hideContextMenu
        }, menuItems.map((item, index) => {
          if (item.label === 'separator') {
            return React.createElement('div', {
              key: `separator-${index}`,
              className: 'context-menu-separator'
            });
          }
          
          return React.createElement('button', {
            key: item.label,
            className: `context-menu-item ${item.destructive ? 'destructive' : ''}`,
            onClick: () => {
              item.action();
              hideContextMenu();
            }
          }, item.label);
        }));
      };

      const renderConfirmationDialog = () => {
        if (!showConfirmDialog) return null;

        const { type, title, message, confirmText, cancelText, onConfirm, onCancel } = showConfirmDialog;

        return React.createElement('div', {
          className: 'confirmation-dialog-overlay',
          onClick: (e) => {
            if (e.target === e.currentTarget) {
              onCancel();
            }
          }
        }, 
          React.createElement('div', {
            className: 'confirmation-dialog'
          }, [
            React.createElement('div', {
              className: 'confirmation-dialog-header',
              key: 'header'
            }, [
              React.createElement('div', {
                className: `confirmation-dialog-icon ${type}`,
                key: 'icon'
              }, type === 'danger' ? '⚠' : '!'),
              React.createElement('h3', {
                className: 'confirmation-dialog-title',
                key: 'title'
              }, title)
            ]),
            React.createElement('div', {
              className: 'confirmation-dialog-message',
              key: 'message'
            }, message),
            React.createElement('div', {
              className: 'confirmation-dialog-actions',
              key: 'actions'
            }, [
              React.createElement('button', {
                className: 'confirmation-dialog-button cancel',
                onClick: onCancel,
                key: 'cancel'
              }, cancelText || 'Cancel'),
              React.createElement('button', {
                className: `confirmation-dialog-button ${type === 'danger' ? 'danger' : 'confirm'}`,
                onClick: onConfirm,
                key: 'confirm'
              }, confirmText || 'Confirm')
            ])
          ])
        );
      };

      // Handle context menu hiding on clicks
      useEffect(() => {
        const handleClick = () => {
          if (contextMenu) {
            hideContextMenu();
          }
        };

        document.addEventListener('click', handleClick);
        return () => document.removeEventListener('click', handleClick);
      }, [contextMenu]);

      // Drag and drop handlers for area tabs
      const handleDragStart = (e, area, index) => {
        setDraggedTab({ area, index });
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.outerHTML);
        e.target.classList.add('dragging');
      };

      const handleDragEnd = (e) => {
        e.target.classList.remove('dragging');
        setDraggedTab(null);
        // Remove drag-over class from all tabs
        document.querySelectorAll('.area-tab').forEach(tab => {
          tab.classList.remove('drag-over');
        });
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      };

      const handleDragEnter = (e) => {
        e.preventDefault();
        e.target.closest('.area-tab')?.classList.add('drag-over');
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        if (!e.target.closest('.area-tab')?.contains(e.relatedTarget)) {
          e.target.closest('.area-tab')?.classList.remove('drag-over');
        }
      };

      const handleDrop = (e, targetIndex) => {
        e.preventDefault();
        e.target.closest('.area-tab')?.classList.remove('drag-over');
        
        if (draggedTab && draggedTab.index !== targetIndex) {
          moveAreaTab(draggedTab.index, targetIndex);
        }
        setDraggedTab(null);
      };

      // Email content processing functions
      const processEmailContent = (content) => {
        if (!content) return 'No content available';
        
        // Remove HTML tags but preserve text content
        let processed = content
          .replace(/<br\s*\/?>/gi, '\n')  // Convert <br> to newlines
          .replace(/<\/p>/gi, '\n\n')     // Convert </p> to double newlines
          .replace(/<[^>]*>/g, '');       // Remove all other HTML tags
        
        // Replace links with [here] placeholder
        processed = processed.replace(
          /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/gi, 
          '[here]'
        );
        
        // Decode common HTML entities
        processed = processed
          .replace(/&nbsp;/gi, ' ')
          .replace(/&amp;/gi, '&')
          .replace(/&lt;/gi, '<')
          .replace(/&gt;/gi, '>')
          .replace(/&quot;/gi, '"')
          .replace(/&#39;/gi, "'");
        
        // Clean up extra whitespace and normalize line breaks
        processed = processed
          .replace(/\n\s*\n\s*\n/g, '\n\n')  // Reduce multiple line breaks
          .replace(/^\s+|\s+$/g, '')         // Trim start/end whitespace
          .replace(/[ \t]+/g, ' ');          // Normalize spaces
        
        return processed || 'No readable content available';
      };

      const processEmailContentWithLinks = (content) => {
        if (!content) return React.createElement('span', { style: { fontStyle: 'italic', color: 'var(--text-secondary)' } }, 'No content available');
        
        // Remove HTML tags but preserve text content
        let processed = content
          .replace(/<br\s*\/?>/gi, '\n')  // Convert <br> to newlines
          .replace(/<\/p>/gi, '\n\n')     // Convert </p> to double newlines
          .replace(/<[^>]*>/g, '');       // Remove all other HTML tags
        
        // Decode common HTML entities
        processed = processed
          .replace(/&nbsp;/gi, ' ')
          .replace(/&amp;/gi, '&')
          .replace(/&lt;/gi, '<')
          .replace(/&gt;/gi, '>')
          .replace(/&quot;/gi, '"')
          .replace(/&#39;/gi, "'");
        
        // Clean up extra whitespace
        processed = processed
          .replace(/\n\s*\n\s*\n/g, '\n\n')  // Reduce multiple newlines to double
          .replace(/^\s+|\s+$/g, '')         // Trim start and end
          .replace(/\t/g, '  ');            // Convert tabs to spaces
        
        // Split content by URLs to create clickable links
        const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/gi;
        const parts = processed.split(urlRegex);
        
        return parts.map((part, index) => {
          if (urlRegex.test(part)) {
            return React.createElement('a', {
              key: index,
              href: part,
              target: '_blank',
              rel: 'noopener noreferrer',
              style: {
                color: '#3b82f6',
                textDecoration: 'underline'
              }
            }, '[here]');
          }
          return part;
        });
      };

      const formatRecipients = (email, showFull = false) => {
        
        if (!email) {
          console.log('❌ No email object provided to formatRecipients');
          return 'No recipients available';
        }
        
        // Debug logging for support@polispark.gr issue
        if (email.sender && email.sender.includes('support@polispark.gr')) {
          console.log('🔍 DEBUG: support@polispark.gr email recipients:', {
            sender: email.sender,
            sender_name: email.sender_name,
            to_recipients: email.to_recipients,
            cc_recipients: email.cc_recipients,
            bcc_recipients: email.bcc_recipients
          });
        }
        
        const sections = [];
        
        // Helper functions for recipient formatting
        const isExchangeAddress = (addr) => {
          return addr && (addr.startsWith('/o=') || addr.startsWith('/O='));
        };
        
        const getReadableRecipient = (recip) => {
          // If we have both name and email, show both
          const hasEmail = recip.email && !isExchangeAddress(recip.email);
          const hasAddress = recip.address && !isExchangeAddress(recip.address);
          const actualEmail = hasEmail ? recip.email : (hasAddress ? recip.address : null);
          
          if (recip.name && actualEmail) {
            return `${recip.name} <${actualEmail}>`;
          }
          
          // If we have actual email but no name, show email only
          if (actualEmail) {
            return actualEmail;
          }
          
          // If we only have name (Exchange internal address), show name only
          if (recip.name) {
            return recip.name;
          }
          
          // Fallback
          return 'Unknown';
        };
        
        const formatRecipientList = (recipients, showFull, recipientType = 'unknown') => {
          return recipients.map((recipient, index) => {
            // Handle if recipient is a string or object
            if (typeof recipient === 'string') {
              return recipient;
            }
            
            // Apply toggle logic: showFull controls display format
            if (showFull) {
              // Show "Name <email>" format when toggled on
              const hasEmail = recipient.email && !isExchangeAddress(recipient.email);
              const hasAddress = recipient.address && !isExchangeAddress(recipient.address);
              
              // Try to extract email from Exchange address as fallback
              let actualEmail = null;
              if (hasEmail) {
                actualEmail = recipient.email;
              } else if (hasAddress) {
                actualEmail = recipient.address;
              } else if (recipient.address && isExchangeAddress(recipient.address)) {
                // Extract username from Exchange address and create likely email
                const match = recipient.address.match(/cn=([a-zA-Z0-9\-]+)/);
                if (match && match[1]) {
                  const cnValue = match[1];
                  // Try to extract meaningful username from CN value
                  let username = null;
                  
                  // Check for known pattern: UUID-username (like 506b8eb39253431b91e2e8be271e9e96-knakos)
                  const uuidUsernameMatch = cnValue.match(/^[a-f0-9]{8,}-(.+)$/);
                  if (uuidUsernameMatch && uuidUsernameMatch[1]) {
                    username = uuidUsernameMatch[1];
                  } 
                  // Check for direct username pattern (like user12345 or knakos)
                  else if (cnValue.match(/^(user[a-z0-9]+|[a-z]+[a-z0-9]*)$/i)) {
                    username = cnValue.replace(/^user/, ''); // Remove 'user' prefix if present
                  }
                  
                  if (username && username.length > 2) {
                    actualEmail = `${username}@nbg.gr`;
                  }
                }
              }
              
              
              if (recipient.name && actualEmail) {
                return `${recipient.name} <${actualEmail}>`;
              } else if (actualEmail) {
                return actualEmail;
              } else {
                return recipient.name || 'Unknown';
              }
            } else {
              // Show just name when toggled off
              return recipient.name || recipient.email || recipient.address || 'Unknown';
            }
          }).join(', ');
        };
        
        // Handle To recipients
        const toRecipients = email.to_recipients || email.recipients || email.to || [];
        
        if (toRecipients && toRecipients.length > 0) {
          const toList = formatRecipientList(toRecipients, showFull, 'to');
          sections.push(`To: ${toList}`);
        }
        
        // Handle Cc recipients
        const ccRecipients = email.cc_recipients || email.cc || [];
        
        if (ccRecipients && ccRecipients.length > 0) {
          const ccList = formatRecipientList(ccRecipients, showFull, 'cc');
          sections.push(`Cc: ${ccList}`);
        }
        
        // Handle Bcc recipients (if available)
        const bccRecipients = email.bcc_recipients || email.bcc || [];
        if (bccRecipients && bccRecipients.length > 0) {
          const bccList = formatRecipientList(bccRecipients, showFull, 'bcc');
          sections.push(`Bcc: ${bccList}`);
        }
        
        
        // If no recipients found, show appropriate message without sender information
        if (sections.length === 0) {
          const availableFields = Object.keys(email).filter(key => 
            key.toLowerCase().includes('recipient') || 
            key.toLowerCase().includes('to') || 
            key.toLowerCase().includes('cc') ||
            key.toLowerCase().includes('bcc')
          );
          console.log('❌ No recipients sections created. Available email fields:', availableFields);
          console.log('🚨 PROBLEM: Will return "Recipients not available"');
          return 'Recipients not available';
        }
        
        return sections.join('\n');
      };

      // Navigation items with SVG icons
      const navItems = [
        { 
          id: 'inbox', 
          label: 'Inbox', 
          icon: React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 }, [
            React.createElement('path', { key: 'path1', d: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z' }),
            React.createElement('polyline', { key: 'polyline1', points: '9,22 9,12 15,12 15,22' })
          ])
        },
        { 
          id: 'emails', 
          label: 'Smart Emails', 
          icon: React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 }, [
            React.createElement('path', { key: 'path1', d: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z' }),
            React.createElement('polyline', { key: 'polyline1', points: '22,6 12,13 2,6' })
          ])
        },
        { 
          id: 'projects', 
          label: 'Projects', 
          icon: React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 }, [
            React.createElement('path', { key: 'path1', d: 'M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4' }),
            React.createElement('polyline', { key: 'polyline1', points: '9,11 12,14 15,11' }),
            React.createElement('line', { key: 'line1', x1: 12, y1: 14, x2: 12, y2: 3 })
          ])
        },
        { 
          id: 'profile', 
          label: 'Profile', 
          icon: React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 }, [
            React.createElement('path', { key: 'path1', d: 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2' }),
            React.createElement('circle', { key: 'circle1', cx: 12, cy: 7, r: 4 })
          ])
        },
        { 
          id: 'contacts', 
          label: 'Network', 
          icon: React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 }, [
            React.createElement('path', { key: 'path1', d: 'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2' }),
            React.createElement('circle', { key: 'circle1', cx: 9, cy: 7, r: 4 }),
            React.createElement('path', { key: 'path2', d: 'M23 21v-2a4 4 0 0 0-3-3.87' }),
            React.createElement('path', { key: 'path3', d: 'M16 3.13a4 4 0 0 1 0 7.75' })
          ])
        }
      ];

      const renderIconSidebar = () => {
        return React.createElement('aside', { className: 'icon-sidebar' }, [
          React.createElement('nav', { key: 'nav', className: 'icon-nav' },
            navItems.map(item =>
              React.createElement('button', {
                key: item.id,
                className: `icon-btn ${activeRoute === item.id ? 'active' : ''}`,
                onClick: () => setActiveRoute(item.id),
                title: item.label
              }, item.icon)
            )
          )
        ]);
      };

      const renderChatSidebar = () => {
        return React.createElement('aside', { className: 'chat-sidebar' }, [
          // Header
          React.createElement('div', { key: 'header', className: 'chat-header' }, [
            React.createElement('div', { key: 'logo', className: 'logo' }, 'COS'),
            React.createElement('div', { key: 'title', className: 'chat-title' }, [
              React.createElement('h1', { key: 'h1' }, 'Chief of Staff')
            ])
          ]),
          
          // Messages
          React.createElement('div', { key: 'messages', className: 'chat-messages' }, [
            messages.length === 0 ? React.createElement('div', { key: 'welcome', className: 'welcome-screen' }, [
              React.createElement('div', { key: 'icon', className: 'welcome-icon' }, 
                React.createElement('svg', { width: 48, height: 48, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 }, [
                  React.createElement('path', { key: 'path', d: 'M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4' }),
                  React.createElement('polyline', { key: 'polyline', points: '9,11 12,14 15,11' }),
                  React.createElement('line', { key: 'line', x1: 12, y1: 14, x2: 12, y2: 3 })
                ])
              ),
              React.createElement('h2', { key: 'title', className: 'welcome-title' }, 'Welcome to Chief of Staff'),
              React.createElement('p', { key: 'desc', className: 'welcome-description' }, 
                'Your intelligent productivity assistant. Try asking about your emails, projects, or daily planning.'
              ),
              React.createElement('div', { key: 'actions', className: 'quick-actions' },
                [
                  'Help me plan my day',
                  'What\'s in my inbox?',
                  '/outlook connect'
                ].map(suggestion =>
                  React.createElement('button', {
                    key: suggestion,
                    className: 'quick-action',
                    onClick: () => setInputText(suggestion)
                  }, suggestion)
                )
              )
            ]) : messages.map((msg, idx) =>
              React.createElement('div', {
                key: idx,
                className: `message ${msg.role || (msg.sender === 'system' ? 'agent' : 'agent')}${msg.isThinking ? ' thinking' : ''}${msg.isStatus ? ' status' : ''}`
              }, [
                React.createElement('div', { key: 'content', className: 'message-content' }, msg.content || msg.text),
                msg.timestamp && React.createElement('div', { key: 'time', className: 'message-time' }, 
                  new Date(msg.timestamp).toLocaleTimeString()
                )
              ])
            ),
            React.createElement('div', { key: 'end', ref: messagesEndRef })
          ]),
          
          // Input
          React.createElement('div', { key: 'input-area', className: 'chat-input-area' }, [
            React.createElement('div', { key: 'wrapper', className: 'chat-input-wrapper' }, [
              React.createElement('input', {
                key: 'input-field',
                className: 'chat-input-field',
                type: 'text',
                placeholder: 'Ask me anything...',
                value: inputText,
                onChange: (e) => setInputText(e.target.value),
                onKeyPress: handleKeyPress,
                disabled: connectionStatus !== 'connected'
              }),
              React.createElement('button', {
                key: 'send',
                className: 'chat-send-btn',
                onClick: sendMessage,
                disabled: !inputText.trim() || connectionStatus !== 'connected'
              }, 'Send')
            ])
          ])
        ]);
      };

      const renderStatusBar = () => {
        console.log('Rendering status bar...', connectionStatus);
        return React.createElement('div', { className: 'status-bar' }, [
          React.createElement('div', { key: 'indicators', className: 'status-indicators' }, [
            // Backend Status
            React.createElement('div', { 
              key: 'backend', 
              className: `status-indicator ${connectionStatus}`,
              'data-label': connectionStatus.substring(0, 1).toUpperCase()
            }, [
              React.createElement('div', {
                key: 'dot',
                className: `status-dot ${connectionStatus}`
              }),
              React.createElement('span', { key: 'text' }, `Backend ${connectionStatus}`)
            ]),
            // AI Status with Usage
            React.createElement('div', { 
              key: 'ai', 
              className: 'status-indicator ai',
              'data-label': 'AI',
              title: `Today: ${usageStats.calls_today || 0} calls (${usageStats.api_calls || 0} API, ${usageStats.mock_responses || 0} mock, ${(usageStats.cache_hit_rate || 0).toFixed(1)}% cache hit rate) | Cost: $${(usageStats.estimated_cost || 0).toFixed(4)}`
            }, [
              React.createElement('div', {
                key: 'dot',
                className: 'status-dot connected'
              }),
              React.createElement('span', { key: 'text' }, 
                `Claude-3.5 | ${usageStats.calls_today || 0} calls | $${(usageStats.estimated_cost || 0).toFixed(4)}`
              )
            ]),
            // Outlook Status
            React.createElement('div', { 
              key: 'outlook', 
              className: `status-indicator ${outlookStatus}`,
              'data-label': 'OUT'
            }, [
              React.createElement('div', {
                key: 'dot',
                className: `status-dot ${outlookStatus}`
              }),
              React.createElement('span', { key: 'text' }, `Outlook:${outlookStatus.charAt(0).toUpperCase() + outlookStatus.slice(1)}`)
            ])
          ]),
          React.createElement('div', { key: 'info' }, [
            React.createElement('span', { key: 'text' }, 'Ready')
          ])
        ]);
      };

      const renderEmailList = () => {
        
        return React.createElement('div', { className: 'email-panel' }, [
          React.createElement('div', { key: 'header', className: 'panel-header' }, [
            React.createElement('h2', { key: 'title', className: 'panel-title' }, 'Smart Email List'),
            React.createElement('p', { key: 'subtitle', className: 'panel-subtitle' }, 
              `${emails.length} emails with AI-powered insights`
            )
          ]),
          // Show loading spinner when emails are loading, otherwise show email list
          emailsLoading ? 
            React.createElement('div', { 
              key: 'loading', 
              className: 'email-list-loading' 
            }, [
              React.createElement('div', { key: 'spinner', className: 'loading-spinner' }),
              React.createElement('div', { key: 'text', className: 'loading-text' }, 'Loading emails...'),
              React.createElement('div', { key: 'subtext', className: 'loading-subtext' }, 'Please wait while we fetch your latest messages')
            ]) :
            React.createElement('div', { 
              key: 'list', 
              className: 'email-list'
            },
              emails.length === 0 ?
                React.createElement('div', { 
                  key: 'empty', 
                  className: 'email-list-loading' 
                }, [
                  React.createElement('div', { key: 'text', className: 'loading-text' }, 'No emails found'),
                  React.createElement('div', { key: 'subtext', className: 'loading-subtext' }, 'Try connecting to Outlook or refreshing the list')
                ]) :
                emails.map(email =>
              React.createElement('div', {
                key: email.id,
                className: `email-item ${selectedEmail?.id === email.id ? 'selected' : ''}`,
                onClick: () => handleEmailSelect(email),
                onContextMenu: (e) => {
                  e.preventDefault();
                  setContextMenu({
                    visible: true,
                    x: e.clientX,
                    y: e.clientY,
                    email: email
                  });
                },
                style: {
                  padding: '8px 12px',
                  marginBottom: '4px',
                  lineHeight: '1.3',
                  position: 'relative',
                  display: 'flex',
                  flexDirection: 'column',
                  minHeight: '80px'
                }
              }, [
                React.createElement('div', { 
                  key: 'meta', 
                  className: 'email-meta',
                  style: {
                    marginBottom: '2px',
                    fontSize: '12px'
                  }
                }, [
                  React.createElement('span', { key: 'sender', className: 'email-sender' }, email.sender),
                  React.createElement('span', { key: 'time', className: 'email-time' }, formatDate(email.received_at))
                ]),
                React.createElement('div', { 
                  key: 'subject', 
                  className: 'email-subject',
                  style: {
                    margin: '2px 0',
                    fontSize: '14px',
                    fontWeight: '500'
                  }
                }, email.subject),
                React.createElement('div', {
                  key: 'flags',
                  style: {
                    marginTop: 'auto',
                    paddingTop: '4px',
                    display: 'flex',
                    gap: '6px',
                    flexWrap: 'wrap',
                    alignItems: 'flex-end'
                  }
                }, [
                  React.createElement('span', {
                    key: 'priority',
                    className: `assessment-flag email-priority priority-${email.priority.toLowerCase()}`,
                    style: getAssessmentStyle('priority', email.priority)
                  }, (email.priority === 'Unassessed' ? 'PRIORITY' : email.priority.toUpperCase())),
                  React.createElement('span', {
                    key: 'tone',
                    className: `assessment-flag email-tone tone-${(email.tone || 'unassessed').toLowerCase()}`,
                    style: getAssessmentStyle('tone', email.tone || 'Unassessed')
                  }, ((email.tone || 'Unassessed') === 'Unassessed' ? 'TONE' : (email.tone || 'Unassessed').toUpperCase())),
                  React.createElement('span', {
                    key: 'urgency',
                    className: `assessment-flag email-urgency urgency-${(email.urgency || 'unassessed').toLowerCase()}`,
                    style: getAssessmentStyle('urgency', email.urgency || 'Unassessed')
                  }, ((email.urgency || 'Unassessed') === 'Unassessed' ? 'URGENCY' : (email.urgency || 'Unassessed').toUpperCase()))
                ]),
                // Processing dots indicator
                email.isProcessing ? React.createElement('div', {
                  key: 'processing',
                  className: 'processing-dots'
                }, [
                  React.createElement('div', { key: 'dot1', className: 'dot' }),
                  React.createElement('div', { key: 'dot2', className: 'dot' }),
                  React.createElement('div', { key: 'dot3', className: 'dot' })
                ]) : null
              ])
            )
          )
        ]);
      };

      const renderEmailDetail = () => {
        console.log('🖼️ RENDERING EMAIL DETAIL:', {
          has_selected_email: !!selectedEmail,
          selected_email_id: selectedEmail?.id,
          selected_email_subject: selectedEmail?.subject,
          body_content_length: selectedEmail?.body_content?.length || 0,
          body_length: selectedEmail?.body?.length || 0,
          preview_length: selectedEmail?.preview?.length || 0,
          available_fields: selectedEmail ? Object.keys(selectedEmail) : [],
          isProcessing: selectedEmail?.isProcessing,
          hasAnalysis: !!selectedEmail?.analysis,
          summaryText: selectedEmail?.analysis?.summary,
          analysisKeys: selectedEmail?.analysis ? Object.keys(selectedEmail.analysis) : []
        });
        
        if (!selectedEmail) {
          return React.createElement('div', { className: 'email-panel' }, [
            React.createElement('div', { key: 'empty', className: 'email-detail-empty' }, [
              React.createElement('div', { key: 'icon', className: 'empty-icon' }, 
                React.createElement('svg', { width: 48, height: 48, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 }, [
                  React.createElement('path', { key: 'path', d: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z' }),
                  React.createElement('polyline', { key: 'polyline', points: '22,6 12,13 2,6' })
                ])
              ),
              React.createElement('h3', { key: 'title', className: 'empty-title' }, 'Smart Email Intelligence'),
              React.createElement('p', { key: 'desc', className: 'empty-description' }, 
                'Select an email from the right panel to see AI-powered analysis and context-aware recommendations.'
              )
            ])
          ]);
        }

        const analysis = selectedEmail.analysis || {};
        
        // Provide default analysis structure if not available
        const defaultAnalysis = {
          key_points: ['Email analysis not yet available'],
          tone: 'neutral',
          urgency_level: 'medium',
          requires_action: false,
          recommendations: [{
            action: 'Analyze Email',
            confidence: 0.9,
            description: 'Generate AI analysis for this email'
          }]
        };
        
        const finalAnalysis = analysis.key_points ? analysis : defaultAnalysis;
        
        return React.createElement('div', { className: 'email-panel' }, [
          React.createElement('div', { key: 'header', className: 'panel-header' }, [
            React.createElement('h2', { key: 'title', className: 'panel-title' }, selectedEmail.subject || 'No Subject'),
            React.createElement('p', { key: 'subtitle', className: 'panel-subtitle' }, 
              `From: ${selectedEmail.sender || 'Unknown'} • ${selectedEmail.received_at ? formatTime(selectedEmail.received_at) : 'Unknown date'}`
            )
          ]),
          // Show analysis loading indicator when email is processing
          selectedEmail.isProcessing ? React.createElement('div', { 
            key: 'analysis-loading', 
            style: { 
              marginBottom: '16px', 
              padding: '12px 16px', 
              background: 'rgba(59, 130, 246, 0.1)', 
              border: '1px solid var(--brand-primary)', 
              borderRadius: '8px',
              display: 'flex',
              alignItems: 'center',
              gap: '12px'
            } 
          }, [
            React.createElement('div', { key: 'spinner', className: 'loading-spinner', style: { width: '20px', height: '20px', marginBottom: '0' } }),
            React.createElement('div', { key: 'text-container' }, [
              React.createElement('div', { key: 'text', style: { color: 'var(--brand-primary)', fontSize: '14px', fontWeight: '600' } }, 'AI Analysis in Progress'),
              React.createElement('div', { key: 'subtext', style: { color: 'var(--text-secondary)', fontSize: '12px', marginTop: '2px' } }, 'Analyzing email content, tone, and priority...')
            ])
          ]) : null,
          React.createElement('div', { key: 'recipients', style: { marginBottom: '20px', padding: '12px', background: 'var(--bg-secondary)', borderRadius: '8px', border: '1px solid var(--border)' } }, [
            React.createElement('div', { key: 'header', style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' } }, [
              React.createElement('h4', { key: 'title', style: { margin: '0', fontSize: '14px', color: 'var(--text-primary)', fontWeight: '600' } }, 'Recipients'),
              React.createElement('button', {
                key: 'toggle',
                style: {
                  padding: '4px 8px',
                  background: 'transparent',
                  border: '1px solid var(--border)',
                  borderRadius: '4px',
                  fontSize: '11px',
                  color: 'var(--text-secondary)',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                },
                onMouseEnter: (e) => {
                  e.target.style.background = 'var(--surface-hover)';
                  e.target.style.borderColor = 'var(--brand-primary)';
                },
                onMouseLeave: (e) => {
                  e.target.style.background = 'transparent';
                  e.target.style.borderColor = 'var(--border)';
                },
                onClick: () => setShowFullRecipients(!showFullRecipients)
              }, showFullRecipients ? 'Names Only' : 'Names + Emails')
            ]),
            React.createElement('div', { 
              key: `recipient-list-${showFullRecipients}`, 
              style: { 
                margin: '0', 
                fontSize: '13px', 
                color: 'var(--text-secondary)', 
                lineHeight: '1.4',
                wordBreak: 'break-word',
                whiteSpace: 'pre-line'
              } 
            }, formatRecipients(selectedEmail, showFullRecipients))
          ]),
          // Summary Panel with Processing States
          React.createElement('div', { key: 'summary', style: { marginBottom: '20px', padding: '16px', background: '#fdf2f8', borderRadius: '8px', border: '1px solid #f9a8d4' } }, [
            React.createElement('h4', { key: 'title', style: { margin: '0 0 12px 0', fontSize: '14px', color: 'var(--text-primary)', fontWeight: '600' } }, 'Summary'),
            React.createElement('div', { 
              key: 'content', 
              style: { 
                fontSize: '14px',
                color: 'var(--text-primary)',
                lineHeight: '1.5',
                fontStyle: selectedEmail.analysis?.summary ? 'normal' : 'italic',
                minHeight: '40px',
                display: 'flex',
                alignItems: 'center'
              } 
            }, 
              selectedEmail.isProcessing ? 
                React.createElement('div', {
                  key: 'processing',
                  style: { display: 'flex', alignItems: 'center', gap: '8px' }
                }, [
                  React.createElement('span', { key: 'text' }, 'Generating summary'),
                  React.createElement('div', { key: 'dots', className: 'processing-dots' }, [
                    React.createElement('div', { key: 'dot1' }),
                    React.createElement('div', { key: 'dot2' }),
                    React.createElement('div', { key: 'dot3' })
                  ])
                ])
                : selectedEmail.analysis?.summary || 'No AI summary available. Right-click this email to generate analysis.'
            )
          ]),
          React.createElement('div', { key: 'content', style: { flex: 1, display: 'flex', flexDirection: 'column' } }, [
            React.createElement('div', { 
              key: 'preview', 
              style: { 
                flex: 1,
                padding: '16px', 
                background: 'var(--bg-tertiary)', 
                borderRadius: '8px', 
                display: 'flex', 
                flexDirection: 'column',
                position: 'relative',
                minHeight: 0
              },
              onContextMenu: (e) => {
                e.preventDefault();
                if (wsRef.current) {
                  const message = {
                    event: 'email:analyze',
                    data: { 
                      email_id: selectedEmail.id,
                      subject: selectedEmail.subject,
                      content: selectedEmail.preview || selectedEmail.body,
                      sender: selectedEmail.sender
                    }
                  };
                  wsRef.current.send(JSON.stringify(message));
                  console.log('🔄 Renewing email analysis via right-click:', message);
                }
              },
              title: 'Right-click to renew AI analysis'
            }, [
              React.createElement('h4', { key: 'title', style: { margin: '0 0 8px 0', fontSize: '14px', color: 'var(--text-primary)', fontWeight: '600' } }, 'Body'),
              React.createElement('div', { 
                key: 'content', 
                style: { 
                  flex: 1,
                  margin: '0',
                  color: 'var(--text-primary)', 
                  lineHeight: '1.6',
                  fontSize: '14px',
                  fontWeight: 'normal',
                  fontFamily: 'system-ui, -apple-system, sans-serif',
                  whiteSpace: 'pre-wrap',
                  overflowY: 'auto',
                  overflowX: 'hidden',
                  padding: '8px 12px',
                  border: '1px solid var(--border)',
                  borderRadius: '4px',
                  minHeight: '200px',
                  maxHeight: '400px',
                  backgroundColor: 'var(--bg-primary)'
                } 
              }, (() => {
                const content = selectedEmail.body_content || selectedEmail.body || selectedEmail.content || selectedEmail.text_content || selectedEmail.preview || '';
                console.log('📧 EMAIL BODY CONTENT BEING DISPLAYED:', {
                  body_content_length: selectedEmail.body_content?.length || 0,
                  body_length: selectedEmail.body?.length || 0,
                  content_length: selectedEmail.content?.length || 0,
                  text_content_length: selectedEmail.text_content?.length || 0,
                  preview_length: selectedEmail.preview?.length || 0,
                  using_content_type: selectedEmail.body_content ? 'body_content' : 
                                     selectedEmail.body ? 'body' :
                                     selectedEmail.content ? 'content' :
                                     selectedEmail.text_content ? 'text_content' :
                                     selectedEmail.preview ? 'preview' : 'empty',
                  first_100_chars: content.substring(0, 100)
                });
                return processEmailContentWithLinks(content);
              })())
            ]),
          ])
        ]);
      };

      // Project Management Render Functions
      const renderTaskWorkspace = () => {
        if (projectsLoading) {
          return React.createElement('div', { className: 'task-panel loading' }, [
            React.createElement('div', { key: 'spinner', className: 'loading-spinner' }),
            React.createElement('p', { key: 'text' }, 'Loading project data...')
          ]);
        }

        if (!selectedProject) {
          return React.createElement('div', { className: 'task-panel' }, [
            React.createElement('div', { key: 'empty', className: 'task-detail-empty' }, [
              React.createElement('div', { key: 'icon', className: 'empty-icon' }, 
                React.createElement('svg', { width: 48, height: 48, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 }, [
                  React.createElement('path', { key: 'path', d: 'M9 12l2 2 4-4M21 12a9 9 0 11-18 0 9 9 0 0118 0z' })
                ])
              ),
              React.createElement('h3', { key: 'title', className: 'empty-title' }, 'Project Task Management'),
              React.createElement('p', { key: 'desc', className: 'empty-description' }, 
                'Select a project from the navigator to manage tasks and track progress.'
              )
            ])
          ]);
        }

        return React.createElement('div', { className: 'task-panel' }, [
          React.createElement('div', { key: 'header', className: 'panel-header' }, [
            React.createElement('h2', { key: 'title', className: 'panel-title' }, selectedProject.name),
            React.createElement('p', { key: 'subtitle', className: 'panel-subtitle' }, 
              `Area: ${selectedArea?.name || 'Unknown'} • ${tasks.length} task${tasks.length !== 1 ? 's' : ''}`
            )
          ]),
          React.createElement('div', { key: 'tasks-header', className: 'tasks-header' }, [
            React.createElement('h3', { key: 'title' }, 'Tasks'),
            React.createElement('button', { 
              key: 'new-task',
              className: 'btn btn-sm btn-outline',
              onClick: createNewTask
            }, '+ Task')
          ]),
          React.createElement('div', { key: 'task-list', className: 'task-list' }, 
            (() => {
              const activeTasks = tasks.filter(t => t.status !== 'archived');
              const archivedTasks = tasks.filter(t => t.status === 'archived');
              
              const renderTask = (task, isArchived = false) => {
                const isEditing = editingItems.tasks.has(task.id);
                const isSaving = savingItems.tasks.has(task.id);
                const isNew = task.is_new;
                
                if (isEditing) {
                  return React.createElement('div', { 
                    key: task.id, 
                    className: `task-item item-editing ${selectedTask?.id === task.id ? 'selected' : ''} ${isSaving ? 'saving' : ''}`,
                  }, [
                    React.createElement('div', { key: 'editing-content', className: 'task-editing-content' }, [
                      React.createElement('input', {
                        key: 'title',
                        className: `editing-field ${isNew ? 'template' : ''}`,
                        'data-field': `task-title-${task.id}`,
                        value: task.title,
                        tabIndex: 0,
                        onFocus: (e) => {
                          if (isNew && e.target.value === "New Task") {
                            e.target.select();
                          }
                        },
                        onChange: (e) => {
                          setTasks(prev => prev.map(t => 
                            t.id === task.id ? { ...t, title: e.target.value } : t
                          ));
                        },
                        onKeyDown: (e) => {
                          if (e.key === 'Enter') {
                            saveItem('task', tasks.find(t => t.id === task.id));
                          } else if (e.key === 'Escape') {
                            cancelEdit('task', task.id);
                          } else if (e.key === 'Tab') {
                            e.preventDefault();
                            const objectiveField = document.querySelector(`textarea[data-field="task-objective-${task.id}"]`);
                            if (objectiveField) objectiveField.focus();
                          }
                        }
                      }),
                      React.createElement('textarea', {
                        key: 'objective',
                        className: `editing-field ${isNew ? 'template' : ''}`,
                        'data-field': `task-objective-${task.id}`,
                        value: task.objective,
                        placeholder: 'What specific outcome should this task achieve?',
                        tabIndex: 0,
                        onFocus: (e) => {
                          if (isNew && e.target.value === "What needs to be accomplished") {
                            e.target.select();
                          }
                        },
                        onChange: (e) => {
                          setTasks(prev => prev.map(t => 
                            t.id === task.id ? { ...t, objective: e.target.value } : t
                          ));
                        },
                        onKeyDown: (e) => {
                          if (e.key === 'Tab') {
                            e.preventDefault();
                            const sponsorField = document.querySelector(`input[data-field="task-sponsor-${task.id}"]`);
                            if (sponsorField) sponsorField.focus();
                          }
                        }
                      }),
                      React.createElement('input', {
                        key: 'sponsor',
                        type: 'email',
                        className: `editing-field ${isNew ? 'template' : ''}`,
                        'data-field': `task-sponsor-${task.id}`,
                        value: task.sponsor_email,
                        placeholder: 'Who wants this done? (sponsor email)',
                        tabIndex: 0,
                        onFocus: (e) => {
                          if (isNew && e.target.value === "") {
                            // Focus on empty field - no need to select
                          }
                        },
                        onChange: (e) => {
                          setTasks(prev => prev.map(t => 
                            t.id === task.id ? { ...t, sponsor_email: e.target.value } : t
                          ));
                        },
                        onKeyDown: (e) => {
                          if (e.key === 'Tab') {
                            e.preventDefault();
                            const ownerField = document.querySelector(`input[data-field="task-owner-${task.id}"]`);
                            if (ownerField) ownerField.focus();
                          }
                        }
                      }),
                      React.createElement('input', {
                        key: 'owner',
                        type: 'email',
                        className: `editing-field ${isNew ? 'template' : ''}`,
                        'data-field': `task-owner-${task.id}`,
                        value: task.owner_email,
                        placeholder: 'Who will do this work? (owner email)',
                        tabIndex: 0,
                        onFocus: (e) => {
                          if (isNew && e.target.value === "") {
                            // Focus on empty field - no need to select
                          }
                        },
                        onChange: (e) => {
                          setTasks(prev => prev.map(t => 
                            t.id === task.id ? { ...t, owner_email: e.target.value } : t
                          ));
                        },
                        onKeyDown: (e) => {
                          if (e.key === 'Tab') {
                            e.preventDefault();
                            const priorityField = document.querySelector(`select[data-field="task-priority-${task.id}"]`);
                            if (priorityField) priorityField.focus();
                          }
                        }
                      }),
                      React.createElement('select', {
                        key: 'priority',
                        className: 'editing-field',
                        'data-field': `task-priority-${task.id}`,
                        value: task.priority || 3,
                        tabIndex: 0,
                        onChange: (e) => {
                          setTasks(prev => prev.map(t => 
                            t.id === task.id ? { ...t, priority: parseInt(e.target.value) } : t
                          ));
                        },
                        onKeyDown: (e) => {
                          if (e.key === 'Tab') {
                            e.preventDefault();
                            const saveBtn = document.querySelector(`button[data-save="task-${task.id}"]`);
                            if (saveBtn) saveBtn.focus();
                          }
                        }
                      }, [
                        React.createElement('option', { key: 1, value: 1 }, 'Priority 1 (High)'),
                        React.createElement('option', { key: 2, value: 2 }, 'Priority 2'),
                        React.createElement('option', { key: 3, value: 3 }, 'Priority 3 (Medium)'),
                        React.createElement('option', { key: 4, value: 4 }, 'Priority 4'),
                        React.createElement('option', { key: 5, value: 5 }, 'Priority 5 (Low)')
                      ]),
                      React.createElement('div', { key: 'actions', className: 'editing-actions' }, [
                        React.createElement('button', {
                          key: 'save',
                          className: 'btn btn-primary',
                          'data-save': `task-${task.id}`,
                          tabIndex: 0,
                          onClick: () => saveItem('task', tasks.find(t => t.id === task.id)),
                          onKeyDown: (e) => {
                            if (e.key === 'Tab') {
                              e.preventDefault();
                              const cancelBtn = document.querySelector(`button[data-cancel="task-${task.id}"]`);
                              if (cancelBtn) cancelBtn.focus();
                            }
                          }
                        }, '✓ Save'),
                        React.createElement('button', {
                          key: 'cancel',
                          className: 'btn btn-outline',
                          'data-cancel': `task-${task.id}`,
                          tabIndex: 0,
                          onClick: () => cancelEdit('task', task.id)
                        }, '✗ Cancel')
                      ])
                    ])
                  ]);
                }
                
                return React.createElement('div', { 
                  key: task.id, 
                  className: `task-item ${selectedTask?.id === task.id ? 'selected' : ''} ${isArchived ? 'archive-section-item' : ''}`,
                  onClick: () => setSelectedTask(task),
                  onContextMenu: (e) => showContextMenu(e, 'task', task)
                }, [
                  React.createElement('div', { key: 'content', className: 'task-content' }, [
                    React.createElement('h4', { 
                      key: 'title', 
                      className: 'task-title editable-field',
                      onClick: (e) => {
                        e.stopPropagation();
                        startEditingItem('task', task.id);
                      },
                      title: 'Click to edit title'
                    }, task.title),
                    React.createElement('p', { 
                      key: 'objective', 
                      className: 'task-objective editable-field',
                      onClick: (e) => {
                        e.stopPropagation();
                        startEditingItem('task', task.id);
                      },
                      title: 'Click to edit objective'
                    }, task.objective || 'Click to add objective'),
                    React.createElement('div', { 
                      key: 'priority', 
                      className: 'task-priority',
                      'data-priority': task.priority || 3
                    }, `Priority: P${task.priority || 3}`),
                    task.sponsor_email ? React.createElement('div', { key: 'sponsor', className: 'task-sponsor' }, 
                      `Sponsor: ${task.sponsor_email}`) : null,
                    task.owner_email ? React.createElement('div', { key: 'owner', className: 'task-owner' }, 
                      `Owner: ${task.owner_email}`) : null,
                    task.due_date ? React.createElement('div', { key: 'due', className: 'task-due' }, 
                      `Due: ${new Date(task.due_date).toLocaleDateString()}`) : null
                  ].filter(Boolean)),
                  React.createElement('div', { key: 'status', className: `task-status status-${task.status}` }, getStatusDisplayText(task.status))
                ]);
              };

              const elements = [];

              // Active tasks section  
              if (activeTasks.length === 0 && archivedTasks.length === 0) {
                elements.push(React.createElement('div', { key: 'no-tasks', className: 'no-tasks' }, [
                  React.createElement('p', { key: 'text' }, 'No tasks in this project yet.')
                ]));
              } else {
                // Show active tasks
                elements.push(...activeTasks.map(task => renderTask(task, false)));

                // Show archived tasks section if there are any
                if (archivedTasks.length > 0) {
                  elements.push(
                    React.createElement('div', { key: 'archive-section-tasks', className: 'archive-section' }, [
                      React.createElement('div', {
                        key: 'archive-header',
                        className: 'archive-section-header',
                        onClick: () => toggleArchiveSection('tasks')
                      }, [
                        React.createElement('span', { 
                          key: 'chevron', 
                          className: `archive-section-chevron ${expandedArchiveSections.tasks ? 'expanded' : ''}` 
                        }, '▶'),
                        React.createElement('span', { key: 'title' }, 'Archived Tasks'),
                        React.createElement('span', { key: 'count', className: 'archive-section-count' }, archivedTasks.length)
                      ]),
                      React.createElement('div', {
                        key: 'archive-content',
                        className: `archive-section-content ${!expandedArchiveSections.tasks ? 'collapsed' : ''}`
                      }, expandedArchiveSections.tasks ? archivedTasks.map(task => renderTask(task, true)) : [])
                    ])
                  );
                }
              }

              return elements;
            })()
          )
        ]);
      };

      const renderProjectNavigator = () => {
        if (projectsLoading) {
          return React.createElement('div', { className: 'project-navigator loading' }, [
            React.createElement('div', { key: 'spinner', className: 'loading-spinner' }),
            React.createElement('p', { key: 'text' }, 'Loading areas and projects...')
          ]);
        }

        const visibleAreas = getVisibleAreas();
        const overflowAreas = getOverflowAreas();
        const hasOverflow = overflowAreas.length > 0;

        return React.createElement('div', { className: 'project-navigator' }, [
          React.createElement('div', { key: 'container', className: 'area-tabs-container' }, [
            // Header with title and carousel navigation
            React.createElement('div', { key: 'header', className: 'area-tabs-header' }, [
              React.createElement('h3', { key: 'title' }, 'Areas'),
              React.createElement('div', { key: 'controls', className: 'carousel-controls' }, [
                React.createElement('button', {
                  key: 'prev',
                  className: 'carousel-btn',
                  onClick: scrollCarouselLeft,
                  disabled: !canScrollLeft(),
                  title: 'Previous areas'
                }, '‹'),
                React.createElement('div', { 
                  key: 'indicator',
                  className: 'carousel-indicator'
                }, (() => {
                  const orderedAreas = getOrderedAreas();
                  if (orderedAreas.length <= visibleTabsCount) return '';
                  const start = carouselOffset + 1;
                  const end = Math.min(carouselOffset + visibleTabsCount, orderedAreas.length);
                  return `${start}-${end} of ${orderedAreas.length}`;
                })()),
                React.createElement('button', {
                  key: 'next', 
                  className: 'carousel-btn',
                  onClick: scrollCarouselRight,
                  disabled: !canScrollRight(),
                  title: 'Next areas'
                }, '›'),
                React.createElement('button', { 
                  key: 'new-area',
                  className: 'btn btn-sm btn-outline',
                  onClick: createNewArea,
                  style: { marginLeft: '12px' }
                }, '+ Area')
              ])
            ]),
            
            // Tabs wrapper
            React.createElement('div', { key: 'wrapper', className: 'area-tabs-wrapper' }, [
              // Visible tabs
              React.createElement('div', { key: 'tabs', className: 'area-tabs-list' }, [
                // Render visible area tabs
                ...visibleAreas.map((area, index) => {
                  const isEditing = editingItems.areas.has(area.id);
                  const isNew = area.is_new;
                  
                  if (isEditing) {
                    return React.createElement('div', { 
                      key: area.id,
                      className: `area-tab editing ${selectedArea?.id === area.id ? 'active' : ''}`,
                    }, [
                      React.createElement('input', {
                        key: 'name-input',
                        className: `editing-field ${isNew ? 'template' : ''} ${area.is_system ? 'disabled' : ''}`,
                        'data-field': `area-name-${area.id}`,
                        value: area.name,
                        tabIndex: 0,
                        readOnly: area.is_system,
                        title: area.is_system ? 'System areas cannot be renamed' : undefined,
                        onFocus: (e) => {
                          if (isNew && e.target.value === "New Area") {
                            e.target.select();
                          }
                        },
                        onChange: (e) => {
                          // Update area in state
                          setAreas(prev => prev.map(a => 
                            a.id === area.id ? { ...a, name: e.target.value } : a
                          ));
                        },
                        onKeyDown: (e) => {
                          if (e.key === 'Enter') {
                            saveItem('area', areas.find(a => a.id === area.id));
                          } else if (e.key === 'Escape') {
                            cancelEdit('area', area.id);
                          } else if (e.key === 'Tab') {
                            e.preventDefault();
                            const descField = document.querySelector(`textarea[data-field="area-description-${area.id}"]`);
                            if (descField) descField.focus();
                          }
                        }
                      }),
                      React.createElement('div', { key: 'editing-form', className: 'area-editing-form' }, [
                        React.createElement('textarea', {
                          key: 'description',
                          className: `editing-field ${isNew ? 'template' : ''}`,
                          'data-field': `area-description-${area.id}`,
                          value: area.description,
                          tabIndex: 0,
                          placeholder: 'Area description',
                          onFocus: (e) => {
                            if (isNew && e.target.value === "Area description") {
                              e.target.select();
                            }
                          },
                          onChange: (e) => {
                            setAreas(prev => prev.map(a => 
                              a.id === area.id ? { ...a, description: e.target.value } : a
                            ));
                          },
                          onKeyDown: (e) => {
                            if (e.key === 'Enter' && !e.shiftKey) {
                              e.preventDefault();
                              saveItem('area', areas.find(a => a.id === area.id));
                            } else if (e.key === 'Escape') {
                              cancelEdit('area', area.id);
                            } else if (e.key === 'Tab') {
                              e.preventDefault();
                              const colorField = document.querySelector(`input[data-field="area-color-${area.id}"]`);
                              if (colorField) colorField.focus();
                            }
                          }
                        }),
                        React.createElement('input', {
                          key: 'color',
                          type: 'color',
                          className: 'editing-field',
                          'data-field': `area-color-${area.id}`,
                          value: area.color,
                          tabIndex: 0,
                          onChange: (e) => {
                            setAreas(prev => prev.map(a => 
                              a.id === area.id ? { ...a, color: e.target.value } : a
                            ));
                          },
                          onKeyDown: (e) => {
                            if (e.key === 'Enter') {
                              saveItem('area', areas.find(a => a.id === area.id));
                            } else if (e.key === 'Escape') {
                              cancelEdit('area', area.id);
                            } else if (e.key === 'Tab') {
                              e.preventDefault();
                              const saveBtn = document.querySelector(`button[data-save="area-${area.id}"]`);
                              if (saveBtn) saveBtn.focus();
                            }
                          }
                        }),
                        React.createElement('div', { key: 'actions', className: 'editing-actions' }, [
                          React.createElement('button', {
                            key: 'save',
                            className: 'btn btn-primary',
                            'data-save': `area-${area.id}`,
                            tabIndex: 0,
                            onClick: () => saveItem('area', areas.find(a => a.id === area.id)),
                            onKeyDown: (e) => {
                              if (e.key === 'Tab') {
                                e.preventDefault();
                                const cancelBtn = document.querySelector(`button[data-cancel="area-${area.id}"]`);
                                if (cancelBtn) cancelBtn.focus();
                              }
                            }
                          }, '✓ Save'),
                          React.createElement('button', {
                            key: 'cancel',
                            className: 'btn btn-outline',
                            'data-cancel': `area-${area.id}`,
                            tabIndex: 0,
                            onClick: () => cancelEdit('area', area.id)
                          }, '✗ Cancel')
                        ])
                      ])
                    ]);
                  }
                  
                  return React.createElement('div', { 
                    key: area.id,
                    className: `area-tab ${selectedArea?.id === area.id ? 'active' : ''}`,
                    draggable: true,
                    onClick: () => handleAreaTabSelect(area),
                    onContextMenu: (e) => {
                      // Show context menu for non-system areas
                      if (!area.is_system) {
                        e.preventDefault();
                        setContextMenu({
                          x: e.clientX,
                          y: e.clientY,
                          type: 'area',
                          item: area
                        });
                      }
                    },
                    onDragStart: (e) => handleDragStart(e, area, index),
                    onDragEnd: handleDragEnd,
                    onDragOver: handleDragOver,
                    onDragEnter: handleDragEnter,
                    onDragLeave: handleDragLeave,
                    onDrop: (e) => handleDrop(e, index)
                  }, [
                    React.createElement('span', { key: 'name', className: 'area-tab-name' }, area.name),
                    React.createElement('span', { key: 'count', className: 'area-tab-count' }, 
                      formatCount(area.project_count || 0))
                  ]);
                })
              ]),
              
              // Projects for selected area
              selectedArea ? React.createElement('div', { key: 'projects-section', className: 'projects-section' }, [
                React.createElement('div', { key: 'projects-header', className: 'projects-header' }, [
                  React.createElement('h4', { key: 'title', style: { margin: 0, fontSize: '14px', fontWeight: 600, color: 'var(--text-primary)' } }, 
                    `${selectedArea.name} Projects`),
                  React.createElement('button', { 
                    key: 'new-project',
                    className: 'btn btn-sm btn-outline',
                    onClick: createNewProject
                  }, '+ Project')
                ]),
                React.createElement('div', { key: 'projects-list', className: 'projects-list', style: { marginTop: '12px' } }, 
                  (() => {
                    const activeProjects = getSortedProjects(projects).filter(p => p.status !== 'archived');
                    const archivedProjects = getSortedProjects(projects).filter(p => p.status === 'archived');
                    
                    const renderProject = (project, isArchived = false) => {
                      const isEditing = editingItems.projects.has(project.id);
                      const isNew = project.is_new;
                      
                      if (isEditing) {
                        return React.createElement('div', { 
                          key: project.id, 
                          className: `project-item item-editing ${selectedProject?.id === project.id ? 'selected' : ''}`,
                        }, [
                          React.createElement('div', { key: 'editing-content', className: 'project-editing-content' }, [
                            React.createElement('input', {
                              key: 'name',
                              className: `editing-field ${isNew ? 'template' : ''}`,
                              'data-field': `project-name-${project.id}`,
                              value: project.name,
                              tabIndex: 0,
                              onFocus: (e) => {
                                if (isNew && e.target.value === "New Project") {
                                  e.target.select();
                                }
                              },
                              onChange: (e) => {
                                setProjects(prev => prev.map(p => 
                                  p.id === project.id ? { ...p, name: e.target.value } : p
                                ));
                              },
                              onKeyDown: (e) => {
                                if (e.key === 'Enter') {
                                  saveItem('project', projects.find(p => p.id === project.id));
                                } else if (e.key === 'Escape') {
                                  cancelEdit('project', project.id);
                                } else if (e.key === 'Tab') {
                                  e.preventDefault();
                                  const descField = document.querySelector(`textarea[data-field="project-description-${project.id}"]`);
                                  if (descField) descField.focus();
                                }
                              }
                            }),
                            React.createElement('textarea', {
                              key: 'description',
                              className: `editing-field ${isNew ? 'template' : ''}`,
                              'data-field': `project-description-${project.id}`,
                              value: project.description,
                              placeholder: 'Project description',
                              tabIndex: 0,
                              onFocus: (e) => {
                                if (isNew && e.target.value === "Project description") {
                                  e.target.select();
                                }
                              },
                              onChange: (e) => {
                                setProjects(prev => prev.map(p => 
                                  p.id === project.id ? { ...p, description: e.target.value } : p
                                ));
                              },
                              onKeyDown: (e) => {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                  e.preventDefault();
                                  saveItem('project', projects.find(p => p.id === project.id));
                                } else if (e.key === 'Escape') {
                                  cancelEdit('project', project.id);
                                } else if (e.key === 'Tab') {
                                  e.preventDefault();
                                  const priorityField = document.querySelector(`select[data-field="project-priority-${project.id}"]`);
                                  if (priorityField) priorityField.focus();
                                }
                              }
                            }),
                            React.createElement('select', {
                              key: 'priority',
                              className: 'editing-field',
                              'data-field': `project-priority-${project.id}`,
                              value: project.priority || 3,
                              tabIndex: 0,
                              onChange: (e) => {
                                setProjects(prev => prev.map(p => 
                                  p.id === project.id ? { ...p, priority: parseInt(e.target.value) } : p
                                ));
                              },
                              onKeyDown: (e) => {
                                if (e.key === 'Enter') {
                                  saveItem('project', projects.find(p => p.id === project.id));
                                } else if (e.key === 'Escape') {
                                  cancelEdit('project', project.id);
                                } else if (e.key === 'Tab') {
                                  e.preventDefault();
                                  const saveBtn = document.querySelector(`button[data-save="project-${project.id}"]`);
                                  if (saveBtn) saveBtn.focus();
                                }
                              }
                            }, [
                              React.createElement('option', { key: 1, value: 1 }, 'Priority 1 (Ultra)'),
                              React.createElement('option', { key: 2, value: 2 }, 'Priority 2 (High)'),
                              React.createElement('option', { key: 3, value: 3 }, 'Priority 3 (Medium)'),
                              React.createElement('option', { key: 4, value: 4 }, 'Priority 4 (Low)'),
                              React.createElement('option', { key: 5, value: 5 }, 'Priority 5 (Base)')
                            ]),
                            React.createElement('div', { key: 'actions', className: 'editing-actions' }, [
                              React.createElement('button', {
                                key: 'save',
                                className: 'btn btn-primary',
                                'data-save': `project-${project.id}`,
                                tabIndex: 0,
                                onClick: () => saveItem('project', projects.find(p => p.id === project.id)),
                                onKeyDown: (e) => {
                                  if (e.key === 'Tab') {
                                    e.preventDefault();
                                    const cancelBtn = document.querySelector(`button[data-cancel="project-${project.id}"]`);
                                    if (cancelBtn) cancelBtn.focus();
                                  }
                                }
                              }, '✓ Save'),
                              React.createElement('button', {
                                key: 'cancel',
                                className: 'btn btn-outline',
                                'data-cancel': `project-${project.id}`,
                                tabIndex: 0,
                                onClick: () => cancelEdit('project', project.id)
                              }, '✗ Cancel')
                            ])
                          ])
                        ]);
                      }
                      
                      return React.createElement('div', { 
                        key: project.id, 
                        className: `project-item ${selectedProject?.id === project.id ? 'selected' : ''} ${isArchived ? 'archive-section-item' : ''}`,
                        onClick: () => {
                          const handleProjectClick = async () => {
                            try {
                              setSelectedProject(project);
                              await loadTasksForProject(project.id);
                            } catch (error) {
                              console.error('Error loading project tasks:', error);
                            }
                          };
                          handleProjectClick();
                        },
                        onContextMenu: (e) => showContextMenu(e, 'project', project)
                      }, [
                        React.createElement('span', { key: 'name', className: 'project-name' }, getProjectDisplayName(project, selectedArea)),
                        React.createElement('span', { 
                          key: 'priority', 
                          className: 'project-priority priority-badge',
                          style: getAssessmentStyle('priority', getPriorityText(project.priority))
                        }, getPriorityText(project.priority)),
                        React.createElement('span', { key: 'status', className: `project-status status-${project.status}` }, getStatusDisplayText(project.status)),
                        React.createElement('span', { key: 'count', className: 'project-task-count' }, 
                          formatCount(project.task_count || 0))
                      ]);
                    };

                    const elements = [];

                    // Active projects section
                    if (activeProjects.length === 0 && archivedProjects.length === 0) {
                      elements.push(React.createElement('div', { key: 'no-projects', className: 'no-projects', style: { padding: '16px', textAlign: 'center', color: 'var(--text-muted)' } }, 
                        'No projects in this area yet.'));
                    } else {
                      // Show active projects
                      elements.push(...activeProjects.map(project => renderProject(project, false)));

                      // Show archived projects section if there are any
                      if (archivedProjects.length > 0) {
                        elements.push(
                          React.createElement('div', { key: 'archive-section', className: 'archive-section' }, [
                            React.createElement('div', {
                              key: 'archive-header',
                              className: 'archive-section-header',
                              onClick: () => toggleArchiveSection('projects')
                            }, [
                              React.createElement('span', { 
                                key: 'chevron', 
                                className: `archive-section-chevron ${expandedArchiveSections.projects ? 'expanded' : ''}` 
                              }, '▶'),
                              React.createElement('span', { key: 'title' }, 'Archived Projects'),
                              React.createElement('span', { key: 'count', className: 'archive-section-count' }, archivedProjects.length)
                            ]),
                            React.createElement('div', {
                              key: 'archive-content',
                              className: `archive-section-content ${!expandedArchiveSections.projects ? 'collapsed' : ''}`
                            }, expandedArchiveSections.projects ? archivedProjects.map(project => renderProject(project, true)) : [])
                          ])
                        );
                      }
                    }

                    return elements;
                  })()
                )
              ]) : null
            ])
          ])
        ]);
      };

      const renderMainContent = () => {
        if (activeRoute === 'emails') {
          return React.createElement('div', { key: 'emails', className: 'email-management' }, [
            React.createElement('div', { key: `email-detail-container-${showFullRecipients}` }, renderEmailDetail()),
            React.createElement('div', { key: 'email-list-container' }, renderEmailList())
          ]);
        } else if (activeRoute === 'projects') {
          return React.createElement('div', { key: 'projects', className: 'project-management' }, [
            React.createElement('div', { key: 'task-workspace-container' }, renderTaskWorkspace()),
            React.createElement('div', { key: 'project-navigator-container' }, renderProjectNavigator())
          ]);
        } else {
          // For other routes, show placeholder content
          return React.createElement('div', {
            key: 'placeholder',
            style: {
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              height: '100%',
              textAlign: 'center'
            }
          }, [
            React.createElement('div', { key: 'content' }, [
              React.createElement('h2', {
                key: 'title',
                style: {
                  margin: '0 0 16px 0',
                  color: 'var(--text-primary)',
                  fontSize: '24px'
                }
              }, activeRoute === 'inbox' ? 'Chat with Chief of Staff' : 
                  activeRoute === 'projects' ? 'Project Dashboard' :
                  activeRoute === 'profile' ? 'Profile Setup' :
                  activeRoute === 'contacts' ? 'Network Management' : 'Dashboard'),
              React.createElement('p', {
                key: 'desc',
                style: {
                  margin: '0',
                  color: 'var(--text-muted)'
                }
              }, activeRoute === 'inbox' ? 'Use the chat panel on the left to interact with your AI assistant.' :
                  'This feature is coming soon...')
            ])
          ]);
        }
      };


      // Click outside to close context menu
      React.useEffect(() => {
        const handleClickOutside = () => {
          if (contextMenu) {
            setContextMenu(null);
          }
        };

        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [contextMenu]);

      // Click outside to save area editing
      React.useEffect(() => {
        const handleClickOutside = (event) => {
          // Check if any areas are being edited
          if (editingItems.areas.size > 0) {
            const editingAreaId = Array.from(editingItems.areas)[0]; // Get first editing area
            const editingArea = areas.find(a => a.id === editingAreaId);
            
            // Check if the click was outside the editing area
            const editingElement = event.target.closest('.area-tab.editing, .area-editing-form');
            
            if (!editingElement && editingArea && !editingArea.is_new) {
              // Auto-save the area if it's not a new area (new areas require explicit save)
              saveItem('area', editingArea);
            }
          }
        };

        document.addEventListener('click', handleClickOutside, true);
        return () => document.removeEventListener('click', handleClickOutside, true);
      }, [editingItems.areas, areas]);

      console.log('🚀 STARTING APP - Rendering main app...');
      console.log('📊 APP STATE:', {
        activeRoute,
        connectionStatus,
        emails_count: emails.length,
        selectedEmail_id: selectedEmail?.id
      });
      
      return React.createElement('div', { className: 'app-layout' }, [
        React.cloneElement(renderIconSidebar(), { key: 'icon-sidebar' }),
        React.cloneElement(renderChatSidebar(), { key: 'chat-sidebar' }),
        React.createElement('main', { key: 'main', className: 'main-content' }, [
          React.createElement('div', { key: 'content', className: 'content-area' }, [
            React.cloneElement(renderMainContent(), { key: 'main-content' })
          ])
        ]),
        React.cloneElement(renderStatusBar(), { key: 'status-bar' }),
        
        // Context Menu
        contextMenu ? React.cloneElement(renderContextMenu(), { key: 'context-menu' }) : null,
        
        // Confirmation Dialog
        showConfirmDialog ? React.cloneElement(renderConfirmationDialog(), { key: 'confirm-dialog' }) : null
      ]);
    }

    // Initialize the app
    function initializeApp() {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(ChiefOfStaffApp));
    }

    // Initialize when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>